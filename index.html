<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Programma Giornaliero Trasformazione Frutta - Simone Gatto</title>
<!-- Importazione librerie esterne -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      padding: 20px;
  }
  
  .main-header {
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }
  
  .section-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      border-left: 4px solid #2a5298;
  }
  
  .section-title {
      color: #1e3c72;
      font-weight: 600;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e9ecef;
  }
  
  .form-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 8px;
  }
  
  .form-control, .form-select {
      border-radius: 8px;
      border: 2px solid #e9ecef;
      padding: 12px 15px;
      font-size: 14px;
      transition: all 0.3s ease;
  }
  
  .form-control:focus, .form-select:focus {
      border-color: #2a5298;
      box-shadow: 0 0 0 0.2rem rgba(42, 82, 152, 0.25);
  }
  
  .btn-primary {
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-weight: 600;
      transition: all 0.3s ease;
  }
  
  .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(42, 82, 152, 0.4);
  }
  
  .btn-success {
      background: linear-gradient(135deg, #28a745, #20c997);
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      font-weight: 600;
      transition: all 0.3s ease;
  }
  
  .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
  }
  
  .btn-warning {
      background: linear-gradient(135deg, #ffc107, #ffb300);
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      font-weight: 600;
      transition: all 0.3s ease;
      color: #212529;
  }
  
  .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
      color: #212529;
  }
  
  .btn-info {
      background: linear-gradient(135deg, #17a2b8, #20c997);
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-weight: 600;
      transition: all 0.3s ease;
      color: white;
  }
  
  .btn-info:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
      color: white;
  }
  
  .calculated-field {
      background-color: #e7f3ff;
      border-color: #bee5eb;
      font-weight: 600;
  }
  
  .supplier-row {
      background-color: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      border: 1px solid #dee2e6;
  }
  
  .bio-indicator {
      background-color: #d4edda;
      color: #155724;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
  }
  
  .bio-red-text {
      color: #dc3545 !important;
      font-weight: 600;
  }
  
  .bio-black-text {
      color: #000000 !important;
      font-weight: 600;
  }
  
  .bio-red-field {
      color: #dc3545 !important;
      font-weight: 600;
      border-color: #dc3545 !important;
  }
  
  .alert-info {
      border-left: 4px solid #0dcaf0;
      background-color: #cff4fc;
      border-radius: 8px;
  }
  
  .table th {
      background-color: #1e3c72;
      color: white;
      border: none;
      font-weight: 600;
  }
  
  .table td {
      vertical-align: middle;
      border-color: #e9ecef;
  }
  
  .progress {
      height: 8px;
      border-radius: 4px;
  }
  
  .hidden-field {
      display: none;
  }
  
  .time-display {
      font-family: 'Courier New', monospace;
      font-size: 16px;
      font-weight: bold;
      color: #1e3c72;
  }
  
  .yield-result {
      background-color: #e8f5e8;
      border-color: #28a745;
      font-weight: 600;
      text-align: center;
  }
  
  .revision-info {
      font-size: 12px;
      color: #6c757d;
      margin-top: 10px;
  }
  
  .supplier-selection {
      background-color: #e8f5e8;
      border: 2px solid #28a745;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
  }
  
  .next-day {
      color: #dc3545;
      font-weight: bold;
      font-size: 12px;
  }
  
  .combination-result {
      background-color: #fff3cd;
      border: 2px solid #ffc107;
      font-weight: bold;
      color: #856404;
  }
  
  .combination-row {
      background-color: #fff3cd !important;
      border: 2px solid #ffc107 !important;
  }
  
  .combination-individual-row {
      background-color: #fff3cd !important;
      border: 1px solid #ffc107 !important;
  }
  
  .auto-sum-field {
      background-color: #fffacd !important;
      border: 2px solid #ffd700 !important;
      font-weight: bold;
  }
  
  .note-field {
      min-height: 60px;
      resize: vertical;
  }
  
  .select2-container {
      width: 100% !important;
  }
  
  .select2-container--default .select2-selection--multiple {
      border: 2px solid #e9ecef;
      border-radius: 8px;
      min-height: 45px;
      padding: 5px;
  }
  
  .select2-container--default.select2-container--focus .select2-selection--multiple {
      border-color: #2a5298;
      box-shadow: 0 0 0 0.2rem rgba(42, 82, 152, 0.25);
  }
  
  .sum-details {
      font-size: 11px;
      color: #856404;
      font-weight: normal;
      margin-top: 5px;
  }
  
  /* Stili per la pagina statistiche */
  .stats-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: none;
      z-index: 1000;
      overflow-y: auto;
  }
  
  .stats-content {
      position: relative;
      background-color: white;
      margin: 2% auto;
      padding: 20px;
      width: 90%;
      max-width: 1400px;
      min-height: 90%;
      border-radius: 15px;
  }
  
  .stats-header {
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  
  .close-stats {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
  }
  
  .close-stats:hover {
      color: #f0f0f0;
  }
  
  .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
  }
  
  .stats-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      border-left: 4px solid #2a5298;
  }
  
  .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
  }
  
  .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
  }
  
  .summary-item {
      background: linear-gradient(135deg, #e7f3ff, #f0f8ff);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  }
  
  .summary-value {
      font-size: 36px;
      font-weight: bold;
      color: #1e3c72;
  }
  
  .summary-label {
      font-size: 14px;
      color: #6c757d;
      margin-top: 5px;
  }
</style>
</head>
<body>
<div class="container-fluid">
  <!-- Header principale -->
  <div class="main-header">
      <h1><i class="bi bi-calendar-check"></i> PROGRAMMA GIORNALIERO TRASFORMAZIONE FRUTTA</h1>
      <h4>Sistema di Gestione Produzione - Simone Gatto</h4>
      <p class="mb-0">Data: <span id="current-date"></span></p>
      <div class="revision-info">
          Ultima revisione: <span id="last-revision"></span>
      </div>
  </div>

  <!-- Sezione Selezione Tipo Agrume -->
  <div class="section-card">
      <h3 class="section-title"><i class="bi bi-gear-fill"></i> Tipo di Agrume</h3>
      <div class="row">
          <div class="col-md-6">
              <label for="tipo-agrume-giornaliero" class="form-label">Seleziona Tipo di Agrume</label>
              <select class="form-select" id="tipo-agrume-giornaliero" required>
                  <option value="">Seleziona il tipo di agrume</option>
                  <option value="LIMONE">Limone</option>
                  <option value="ARANCIA">Arancia</option>
                  <option value="MANDARINO">Mandarino</option>
                  <option value="POMPELMO">Pompelmo</option>
                  <option value="BERGAMOTTO">Bergamotto</option>
              </select>
          </div>
          <div class="col-md-6">
              <label for="data-lavorazione" class="form-label">Data Lavorazione</label>
              <input type="date" class="form-control" id="data-lavorazione" required>
          </div>
      </div>
  </div>

  <!-- Sezione Totali -->
  <div class="section-card">
      <h3 class="section-title"><i class="bi bi-boxes"></i> Quantità Totali</h3>
      <div class="row">
          <div class="col-md-4">
              <label for="entrata-giornaliera" class="form-label">Entrata Giornaliera Totale (kg)</label>
              <input type="number" class="form-control calculated-field" id="entrata-giornaliera" readonly>
          </div>
          <div class="col-md-4">
              <label for="trasformata-totale" class="form-label">Quantità trasformata Totale (kg)</label>
              <input type="number" class="form-control calculated-field" id="trasformata-totale" readonly>
          </div>
          <div class="col-md-4">
              <label for="giacenza-totale" class="form-label">Giacenza Totale (kg)</label>
              <input type="number" class="form-control calculated-field" id="giacenza-totale" readonly>
          </div>
      </div>
  </div>

  <!-- Sezione Fornitori -->
  <div class="section-card">
      <h3 class="section-title"><i class="bi bi-truck"></i> Dettagli Fornitori e Lavorazione</h3>
      <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> Aggiungi i fornitori e configura i parametri di lavorazione per ciascuno. L'orario di fine verrà calcolato automaticamente.
      </div>
      
      <div id="fornitori-container">
          <!-- I fornitori verranno aggiunti dinamicamente qui -->
      </div>
      
      <button type="button" class="btn btn-primary" id="aggiungi-fornitore">
          <i class="bi bi-plus-circle"></i> Aggiungi Fornitore
      </button>
  </div>

  <!-- Sezione Selezione Combinazioni Fornitori (mostrata solo dopo aggiunta fornitori) -->
  <div id="combinazioni-section" class="section-card hidden-field">
      <h3 class="section-title"><i class="bi bi-diagram-3"></i> Selezione Combinazioni Fornitori</h3>
      <div class="supplier-selection">
          <div class="row">
              <div class="col-md-12">
                  <label class="form-label">Seleziona Fornitori da Combinare per Succo 1ª (fino a 3 fornitori)</label>
                  <select class="form-select" id="combinazione-fornitori">
                      <option value="">Seleziona combinazione</option>
                      <!-- Opzioni generate dinamicamente -->
                  </select>
                  <div class="mt-3">
                      <button type="button" class="btn btn-success me-2" id="applica-combinazione">
                          <i class="bi bi-check-circle"></i> Applica Combinazione
                      </button>
                      <button type="button" class="btn btn-warning" id="reset-combinazione">
                          <i class="bi bi-x-circle"></i> Reset Combinazione
                      </button>
                      <small class="text-muted d-block mt-2">
                          Il risultato sostituirà la quantità succo 1ª nell'ultimo fornitore incluso nella combinazione
                      </small>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- Sezione Riepilogo Lavorazione -->
  <div class="section-card">
      <h3 class="section-title"><i class="bi bi-graph-up"></i> Riepilogo Programma Lavorazione</h3>
      <div class="table-responsive">
          <table class="table table-hover" id="riepilogo-table">
              <thead>
                  <tr>
                      <th>Fornitore</th>
                      <th>Q. Entrata (kg)</th>
                      <th>Q. Da trasformare (kg)</th>
                      <th>Giacenza (kg)</th>
                      <th>Certificazione</th>
                      <th>Varietà</th>
                      <th>Linea</th>
                      <th>Portata</th>
                      <th>Inizio</th>
                      <th>Fine</th>
                      <th>Durata</th>
                      <th>Dest.</th>
                      <th>Bio</th>
                      <th>Azioni</th>
                  </tr>
              </thead>
              <tbody>
                  <!-- Dati caricati dinamicamente -->
              </tbody>
          </table>
      </div>
  </div>

  <!-- Pulsanti di azione -->
  <div class="section-card text-center">
      <button type="button" class="btn btn-primary btn-lg me-3" id="salva-programma">
          <i class="bi bi-save"></i> Salva Programma
      </button>
      <button type="button" class="btn btn-outline-secondary btn-lg me-3" id="anteprima-stampa">
          <i class="bi bi-printer"></i> Anteprima Stampa
      </button>
      <button type="button" class="btn btn-info btn-lg me-3" id="apri-statistiche">
          <i class="bi bi-bar-chart-line"></i> Statistiche Interattive
      </button>
      <button type="button" class="btn btn-outline-danger btn-lg" id="reset-programma">
          <i class="bi bi-arrow-clockwise"></i> Reset Programma
      </button>
  </div>
</div>

<!-- Modal Statistiche -->
<div id="stats-modal" class="stats-modal">
  <div class="stats-content">
      <div class="stats-header">
          <h2><i class="bi bi-bar-chart-line"></i> Statistiche Interattive Produzione</h2>
          <span class="close-stats">&times;</span>
      </div>
      
      <div class="stats-summary" id="stats-summary">
          <!-- Sommario statistiche caricate dinamicamente -->
      </div>
      
      <div class="stats-grid">
          <div class="stats-card">
              <h4>Distribuzione Produzione per Fornitore</h4>
              <div class="chart-container">
                  <canvas id="chartFornitori"></canvas>
              </div>
          </div>
          
          <div class="stats-card">
              <h4>Rese Medie per Tipo Prodotto</h4>
              <div class="chart-container">
                  <canvas id="chartRese"></canvas>
              </div>
          </div>
          
          <div class="stats-card">
              <h4>Distribuzione Certificazioni</h4>
              <div class="chart-container">
                  <canvas id="chartCertificazioni"></canvas>
              </div>
          </div>
          
          <div class="stats-card">
              <h4>Timeline Produzione</h4>
              <div class="chart-container">
                  <canvas id="chartTimeline"></canvas>
              </div>
          </div>
          
          <div class="stats-card">
              <h4>Efficienza Linee di Produzione</h4>
              <div class="chart-container">
                  <canvas id="chartEfficienza"></canvas>
              </div>
          </div>
          
          <div class="stats-card">
              <h4>Analisi Destinazioni Prodotti</h4>
              <div class="chart-container">
                  <canvas id="chartDestinazioni"></canvas>
              </div>
          </div>
      </div>
  </div>
</div>

<!-- Template per fornitore -->
<div id="fornitore-template" class="hidden-field">
  <div class="supplier-row" data-supplier-index="">
      <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><i class="bi bi-building"></i> Fornitore <span class="supplier-number"></span></h5>
          <button type="button" class="btn btn-outline-danger btn-sm rimuovi-fornitore">
              <i class="bi bi-trash"></i> Rimuovi
          </button>
      </div>
      
      <div class="row g-3">
          <!-- Dati base fornitore -->
          <div class="col-md-3">
              <label class="form-label">Nome Fornitore</label>
              <select class="form-select nome-fornitore" required>
                  <option value="">Seleziona fornitore</option>
                  <option value="RESTUCCIA">RESTUCCIA</option>
                  <option value="CI">CI</option>
                  <option value="ARCO">ARCO</option>
                  <option value="GIOVINAZZO">GIOVINAZZO</option>
                  <option value="AZ.T.C.">AZ.T.C.</option>
                  <option value="VASTA">VASTA</option>
                  <option value="ALTRO">ALTRO</option>
              </select>
              <input type="text" class="form-control mt-2 altro-fornitore hidden-field" placeholder="Specifica altro fornitore">
          </div>
          
          <div class="col-md-3">
              <label class="form-label">Quantità in Entrata (kg)</label>
              <input type="number" class="form-control quantita-fornitore" min="0" required>
          </div>
          
          <div class="col-md-3">
              <label class="form-label">Quantità trasformata (kg)</label>
              <input type="number" class="form-control quantita-trasformata" min="0" placeholder="0">
          </div>
          
          <div class="col-md-3">
              <label class="form-label">Giacenza (kg)</label>
              <input type="number" class="form-control calculated-field giacenza-fornitore" readonly>
          </div>
          
          <div class="col-md-4">
              <label class="form-label">Certificazione Prodotto</label>
              <select class="form-select certificazione-prodotto" required>
                  <option value="">Seleziona certificazione</option>
                  <option value="BIO EU">BIO EU</option>
                  <option value="BIO DEM">BIO DEM</option>
                  <option value="BIO NTD">BIO NTD</option>
                  <option value="BIO DEM/NTD">BIO DEM/NTD</option>
                  <option value="TRACCIATO">TRACCIATO</option>
                  <option value="IGP">IGP</option>
                  <option value="CONVENZIONALE">CONVENZIONALE</option>
                  <option value="ALTRO">ALTRO</option>
              </select>
              <input type="text" class="form-control mt-2 altra-certificazione hidden-field" placeholder="Specifica altra certificazione">
          </div>
          
          <div class="col-md-4">
              <label class="form-label">Varietà</label>
              <select class="form-select varieta-prodotto" required>
                  <option value="">Seleziona varietà</option>
                  <option value="VERDELLO">Verdello</option>
                  <option value="BIANCHETTO">Bianchetto</option>
                  <option value="FEMMINELLO">Femminello</option>
                  <option value="INTERDONATO">Interdonato</option>
                  <option value="MONACHELLO">Monachello</option>
                  <option value="DI SIRACUSA">Di Siracusa</option>
                  <option value="ALTRO">Altro</option>
              </select>
              <input type="text" class="form-control mt-2 altra-varieta hidden-field" placeholder="Specifica altra varietà">
          </div>
          
          <!-- Parametri lavorazione -->
          <div class="col-md-4">
              <label class="form-label">Linea di Trasformazione</label>
              <select class="form-select linea-trasformazione" required>
                  <option value="">Seleziona linea</option>
                  <option value="BOE/1100">BOE/1100</option>
                  <option value="GOE INT/POLY">GOE INT/POLY</option>
                  <option value="GOE EST/POLY">GOE EST/POLY</option>
                  <option value="GOE EST/400">GOE EST/400</option>
                  <option value="B/SF">B/SF</option>
                  <option value="TORCHI FASO">TORCHI FASO</option>
              </select>
          </div>
          
          <div class="col-md-6">
              <label class="form-label">Portata Impianto (kg/h)</label>
              <input type="number" class="form-control portata-impianto" min="100" max="5000" required>
          </div>
          
          <div class="col-md-6">
              <label class="form-label">Orario Inizio Lavorazione stimato</label>
              <input type="time" class="form-control orario-inizio" required>
          </div>
          
          <div class="col-md-6">
              <label class="form-label">Orario Fine Lavorazione stimato</label>
              <div class="orario-fine-display calculated-field form-control"></div>
          </div>
          
          <div class="col-md-6">
              <label class="form-label">Durata Lavorazione stimata</label>
              <input type="text" class="form-control calculated-field durata-lavorazione" readonly>
          </div>
      </div>
      
      <!-- Sezione Rese e Destinazioni -->
      <div class="mt-4">
          <h6><i class="bi bi-droplet"></i> Calcolo Rese e Destinazioni Spremiture</h6>
          
          <div class="row g-3 mt-2">
              <!-- Rese percentuali -->
              <div class="col-md-4">
                  <label class="form-label">Resa Succo 1ª (%)</label>
                  <input type="number" class="form-control resa-prima" step="0.1" min="0" max="100" placeholder="Auto">
              </div>
              
              <div class="col-md-4 seconda-section">
                  <label class="form-label">Resa Succo 2ª (%)</label>
                  <input type="number" class="form-control resa-seconda" step="0.1" min="0" max="100" placeholder="Auto">
              </div>
              
              <div class="col-md-4">
                  <label class="form-label">Resa Torchiato (%)</label>
                  <input type="number" class="form-control resa-torchiato" step="0.1" min="0" max="100" placeholder="Auto">
              </div>
          </div>
          
          <!-- Risultati calcolo rese in kg -->
          <div class="row g-3 mt-2">
              <div class="col-md-4">
                  <label class="form-label">Quantità Succo 1ª (kg)</label>
                  <input type="number" class="form-control yield-result quantita-prima" readonly>
              </div>
              
              <div class="col-md-4 seconda-section">
                  <label class="form-label">Quantità Succo 2ª (kg)</label>
                  <input type="number" class="form-control yield-result quantita-seconda" readonly>
                  <div class="sum-details seconda-details"></div>
              </div>
              
              <div class="col-md-4">
                  <label class="form-label">Quantità Torchiato (kg)</label>
                  <input type="number" class="form-control yield-result quantita-torchiato" readonly>
                  <div class="sum-details torchiato-details"></div>
              </div>
          </div>
          
          <!-- Destinazioni spremiture -->
          <div class="row g-3 mt-3">
              <div class="col-md-4">
                  <label class="form-label destinazione-prima-label">Destinazione Succo 1ª</label>
                  <select class="form-select destinazione-prima" multiple>
                      <option value="NAT IN TINI">NAT IN TINI</option>
                      <option value="PET 100">PET 100</option>
                      <option value="PET 200">PET 200</option>
                      <option value="PET 480">PET 480</option>
                      <option value="ACMA">ACMA</option>
                      <option value="REX">REX</option>
                      <option value="GOGLIO">GOGLIO</option>
                      <option value="VASCHETTE">VASCHETTE</option>
                      <option value="VASCHETTE ZUCCHERATE">VASCHETTE ZUCCHERATE</option>
                     <option value="LATTE">LATTE</option>
                     <option value="F.F.">F.F.</option>
                     <option value="F.T.C">F.T.C</option>
                     <option value="FBL">FBL</option>
                     <option value="BIC">BIC</option>
                     <option value="CISTERNA P">CISTERNA P</option>
                     <option value="CISTERNA EF">CISTERNA EF</option>
                     <option value="CISTERNA VK">CISTERNA VK</option>
                     <option value="CISTERNA GS">CISTERNA GS</option>
                     <option value="CISTERNA CARTH.">CISTERNA CARTH.</option>
                     <option value="CONCENTRATO">CONCENTRATO</option>
                     <option value="ALTRO">ALTRO</option>
                 </select>
                 <select class="form-select mt-2 bx-concentrato hidden-field">
                     <option value="">Seleziona °BX</option>
                     <option value="32">32 °BX</option>
                     <option value="40">40 °BX</option>
                     <option value="45">45 °BX</option>
                     <option value="48">48 °BX</option>
                     <option value="55">55 °BX</option>
                     <option value="58">58 °BX</option>
                     <option value="60">60 °BX</option>
                     <option value="63.5">63.5 °BX</option>
                     <option value="65">65 °BX</option>
                 </select>
                 <input type="text" class="form-control mt-2 altra-destinazione hidden-field" placeholder="Specifica altra destinazione">
             </div>
             
             <div class="col-md-4 seconda-section">
                 <label class="form-label">Destinazione Succo 2ª</label>
                 <select class="form-select destinazione-seconda">
                     <option value="">Seleziona destinazione</option>
                     <option value="NAT IN TINI">NAT IN TINI</option>
                     <option value="CONCENTRATO">CONCENTRATO</option>
                     <option value="ALTRO">ALTRO</option>
                 </select>
                 <select class="form-select mt-2 bx-concentrato hidden-field">
                     <option value="">Seleziona °BX</option>
                     <option value="32">32 °BX</option>
                     <option value="40">40 °BX</option>
                     <option value="45">45 °BX</option>
                     <option value="48">48 °BX</option>
                     <option value="55">55 °BX</option>
                     <option value="58">58 °BX</option>
                     <option value="60">60 °BX</option>
                     <option value="63.5">63.5 °BX</option>
                     <option value="65">65 °BX</option>
                 </select>
                 <input type="text" class="form-control mt-2 altra-destinazione hidden-field" placeholder="Specifica altra destinazione">
             </div>
             
             <div class="col-md-4">
                 <label class="form-label">Destinazione Torchiato</label>
                 <select class="form-select destinazione-torchiato">
                     <option value="">Seleziona destinazione</option>
                     <option value="NAT IN TINI">NAT IN TINI</option>
                     <option value="F.F.">F.F.</option>
                     <option value="F.T.C">F.T.C</option>
                     <option value="FBL">FBL</option>
                     <option value="BIC">BIC</option>
                     <option value="CONCENTRATO">CONCENTRATO</option>
                     <option value="ALTRO">ALTRO</option>
                 </select>
                 <input type="text" class="form-control mt-2 altra-destinazione hidden-field" placeholder="Specifica altra destinazione">
             </div>
         </div>
         
         <!-- Pastorizzazione -->
         <div class="row g-3 mt-3">
             <div class="col-md-4">
                 <label class="form-label">Pastorizzato</label>
                 <select class="form-select pastorizzato-prima">
                     <option value="SI">SI</option>
                     <option value="NO">NO</option>
                 </select>
             </div>
             
             <div class="col-md-4 seconda-section">
                 <label class="form-label">Pastorizzato</label>
                 <select class="form-select pastorizzato-seconda">
                     <option value="SI">SI</option>
                     <option value="NO">NO</option>
                 </select>
             </div>
             
             <div class="col-md-4">
                 <label class="form-label">Pastorizzato</label>
                 <select class="form-select pastorizzato-torchiato">
                     <option value="SI">SI</option>
                     <option value="NO">NO</option>
                 </select>
             </div>
         </div>
         
         <!-- Tenore di polpa, Brix e Bio per ogni prodotto -->
         <div class="row g-3 mt-3">
             <div class="col-md-4">
                 <label class="form-label">Tenore Polpa Succo 1ª</label>
                 <select class="form-select tenore-polpa-prima">
                     <option value="STANDARD">STANDARD</option>
                     <option value="LIMPIDO">LIMPIDO</option>
                     <option value="SEMICLEAR">SEMICLEAR</option>
                     <option value="1%">1%</option>
                     <option value="2%">2%</option>
                     <option value="3%">3%</option>
                     <option value="6%">6%</option>
                     <option value="ALTRO">ALTRO</option>
                 </select>
                 <input type="text" class="form-control mt-2 altro-tenore-prima hidden-field" placeholder="Specifica altro tenore">
                 
                 <label class="form-label mt-2">Brix</label>
                 <select class="form-select brix-prima">
                     <option value="NAT">NAT</option>
                     <option value="20">20</option>
                     <option value="32">32</option>
                     <option value="40">40</option>
                     <option value="41">41</option>
                     <option value="45">45</option>
                     <option value="55">55</option>
                     <option value="58">58</option>
                     <option value="60">60</option>
                     <option value="63.5">63.5</option>
                     <option value="65">65</option>
                     <option value="ALTRO">ALTRO</option>
                 </select>
                 <input type="text" class="form-control mt-2 altro-brix-prima hidden-field" placeholder="Specifica altro Brix">
                 
                 <label class="form-label mt-2">Biologico</label>
                 <select class="form-select bio-prima">
                     <option value="SI">SI</option>
                     <option value="NO">NO</option>
                     <option value="DECLASSATO">DECLASSATO</option>
                 </select>
                 
                 <label class="form-label mt-2">Conservato</label>
                 <select class="form-select conservato-prima">
                     <option value="SI">SI</option>
                     <option value="NO">NO</option>
                 </select>
                 
                 <label class="form-label mt-2">Note</label>
                 <textarea class="form-control note-field note-prima" placeholder="Inserisci note per Succo 1ª"></textarea>
             </div>
             
             <div class="col-md-4 seconda-section">
                 <label class="form-label">Tenore Polpa Succo 2ª</label>
                 <select class="form-select tenore-polpa-seconda">
                     <option value="STANDARD">STANDARD</option>
                     <option value="LIMPIDO">LIMPIDO</option>
                     <option value="SEMICLEAR">SEMICLEAR</option>
                     <option value="1%">1%</option>
                     <option value="2%">2%</option>
                     <option value="3%">3%</option>
                     <option value="6%">6%</option>
                     <option value="ALTRO">ALTRO</option>
                 </select>
                 <input type="text" class="form-control mt-2 altro-tenore-seconda hidden-field" placeholder="Specifica altro tenore">
                 
                 <label class="form-label mt-2">Brix</label>
                 <select class="form-select brix-seconda">
                     <option value="NAT">NAT</option>
                     <option value="20">20</option>
                     <option value="32">32</option>
                     <option value="40">40</option>
                     <option value="41">41</option>
                     <option value="45">45</option>
                     <option value="55">55</option>
                     <option value="58">58</option>
                     <option value="60">60</option>
                     <option value="63.5">63.5</option>
                     <option value="65">65</option>
                     <option value="ALTRO">ALTRO</option>
                 </select>
                 <input type="text" class="form-control mt-2 altro-brix-seconda hidden-field" placeholder="Specifica altro Brix">
                 
                 <label class="form-label mt-2">Conservato</label>
                 <select class="form-select conservato-seconda">
                     <option value="SI">SI</option>
                     <option value="NO">NO</option>
                 </select>
                 
                 <label class="form-label mt-2">Note</label>
                 <textarea class="form-control note-field note-seconda" placeholder="Inserisci note per Succo 2ª"></textarea>
             </div>
             
             <div class="col-md-4">
                 <label class="form-label">Tenore Polpa Torchiato</label>
                 <select class="form-select tenore-polpa-torchiato">
                     <option value="STANDARD">STANDARD</option>
                     <option value="LIMPIDO">LIMPIDO</option>
                     <option value="SEMICLEAR">SEMICLEAR</option>
                     <option value="1%">1%</option>
                     <option value="2%">2%</option>
                     <option value="3%">3%</option>
                     <option value="6%">6%</option>
                     <option value="ALTRO">ALTRO</option>
                 </select>
                 <input type="text" class="form-control mt-2 altro-tenore-torchiato hidden-field" placeholder="Specifica altro tenore">
                 
                 <label class="form-label mt-2">Brix</label>
                 <select class="form-select brix-torchiato">
                     <option value="NAT">NAT</option>
                     <option value="20">20</option>
                     <option value="32">32</option>
                     <option value="40">40</option>
                     <option value="41">41</option>
                     <option value="45">45</option>
                     <option value="55">55</option>
                     <option value="58">58</option>
                     <option value="60">60</option>
                     <option value="63.5">63.5</option>
                     <option value="65">65</option>
                     <option value="ALTRO">ALTRO</option>
                 </select>
                 <input type="text" class="form-control mt-2 altro-brix-torchiato hidden-field" placeholder="Specifica altro Brix">
                 
                 <label class="form-label mt-2">Conservato</label>
                 <select class="form-select conservato-torchiato">
                     <option value="SI">SI</option>
                     <option value="NO">NO</option>
                 </select>
                 
                 <label class="form-label mt-2">Note</label>
                 <textarea class="form-control note-field note-torchiato" placeholder="Inserisci note per Torchiato"></textarea>
             </div>
         </div>
     </div>
 </div>
</div>

<script>
 $(document).ready(function() {
     let supplierCount = 0;
     let programData = {};
     let lastCombinationSuppliers = '';
     let combinationDetails = []; // Array per salvare i dettagli completi delle combinazioni
     let combinationSupplierIndexes = []; // Array per tenere traccia degli indici dei fornitori in combinazione
     let sumDetailsSeconda = {};
     let sumDetailsTorchiato = {};
     let chartsInitialized = false;
     let charts = {};
     
     // Inizializzazione data corrente e ultima revisione
     function initCurrentDate() {
         const today = new Date();
         const formatted = today.toLocaleDateString('it-IT', {
             weekday: 'long',
             year: 'numeric',
             month: 'long',
             day: 'numeric'
         });
         $('#current-date').text(formatted);
         $('#data-lavorazione').val(today.toISOString().split('T')[0]);
         
         updateLastRevision();
     }
     
     // Aggiorna ultima revisione
     function updateLastRevision() {
         const now = new Date();
         const lastRevision = now.toLocaleDateString('it-IT') + ' - ' + now.toLocaleTimeString('it-IT');
         $('#last-revision').text(lastRevision);
     }
     
     // Calcolo automatico rese in base al tipo di agrume
     function calculateAutoYields(agrume) {
         const yields = {
             'LIMONE': { prima: 30, seconda: 10, torchiato: 5 },
             'ARANCIA': { prima: 35, seconda: 12, torchiato: 6 },
             'MANDARINO': { prima: 42, seconda: 10, torchiato: 4 },
             'POMPELMO': { prima: 30, seconda: 15, torchiato: 6 },
             'BERGAMOTTO': { prima: 30, seconda: 8, torchiato: 3 }
         };
         return yields[agrume] || { prima: 45, seconda: 10, torchiato: 4 };
     }
     
     // Gestione visibilità sezione succo 2ª in base alla linea
     function toggleSecondaSection(supplierElement) {
         const linea = supplierElement.find('.linea-trasformazione').val();
         const secondaSections = supplierElement.find('.seconda-section');
         
         if (linea === 'BOE/1100') {
             secondaSections.removeClass('hidden-field');
         } else {
             secondaSections.addClass('hidden-field');
             // Reset dei valori quando nascosta
             supplierElement.find('.resa-seconda').val('');
             supplierElement.find('.quantita-seconda').val('');
             supplierElement.find('.destinazione-seconda').val('');
             supplierElement.find('.pastorizzato-seconda').val('SI');
             supplierElement.find('.tenore-polpa-seconda').val('STANDARD');
             supplierElement.find('.brix-seconda').val('NAT');
             supplierElement.find('.conservato-seconda').val('SI');
             supplierElement.find('.note-seconda').val('');
         }
     }
     
     // Mostra/nasconde sezione combinazioni
     function toggleCombinazioniSection() {
         const hasSuppliers = $('.supplier-row').length > 0;
         
         if (hasSuppliers) {
             $('#combinazioni-section').removeClass('hidden-field');
         } else {
             $('#combinazioni-section').addClass('hidden-field');
         }
     }
     
     // Aggiorna opzioni select per combinazioni fornitori - MODIFICATA per supportare fino a 3 fornitori
     function updateCombinazioneOptions() {
         const select = $('#combinazione-fornitori');
         
         select.empty().append('<option value="">Seleziona combinazione</option>');
         
         const fornitori = [];
         $('.supplier-row').each(function() {
             const index = $(this).data('supplier-index');
             const fornitore = $(this).find('.nome-fornitore').val() || '';
             const altroFornitore = $(this).find('.altro-fornitore').val();
             const nomeFornitore = fornitore === 'ALTRO' ? altroFornitore : fornitore;
             const certificazione = $(this).find('.certificazione-prodotto').val() || 'N/D';
             const lineaTrasformazione = $(this).find('.linea-trasformazione').val() || 'N/D';
             
             if (nomeFornitore) {
                 fornitori.push({ 
                     index: index, 
                     nome: nomeFornitore,
                     certificazione: certificazione,
                     linea: lineaTrasformazione
                 });
             }
         });
         
         // Combinazioni di 2 fornitori
         for (let i = 0; i < fornitori.length; i++) {
             for (let j = i + 1; j < fornitori.length; j++) {
                 const combo = `${fornitori[i].index},${fornitori[j].index}`;
                 const label = `F${fornitori[i].index} - ${fornitori[i].nome} [${fornitori[i].certificazione}|${fornitori[i].linea}] + F${fornitori[j].index} - ${fornitori[j].nome} [${fornitori[j].certificazione}|${fornitori[j].linea}]`;
                 select.append(`<option value="${combo}">${label}</option>`);
             }
         }
         
         // Combinazioni di 3 fornitori
         for (let i = 0; i < fornitori.length; i++) {
             for (let j = i + 1; j < fornitori.length; j++) {
                 for (let k = j + 1; k < fornitori.length; k++) {
                     const combo = `${fornitori[i].index},${fornitori[j].index},${fornitori[k].index}`;
                     const label = `F${fornitori[i].index} - ${fornitori[i].nome} [${fornitori[i].certificazione}|${fornitori[i].linea}] + F${fornitori[j].index} - ${fornitori[j].nome} [${fornitori[j].certificazione}|${fornitori[j].linea}] + F${fornitori[k].index} - ${fornitori[k].nome} [${fornitori[k].certificazione}|${fornitori[k].linea}]`;
                     select.append(`<option value="${combo}">${label}</option>`);
                 }
             }
         }
     }
     
     // Trova l'ultimo fornitore incluso in una combinazione
     function getLastSupplierInCombination(comboValue) {
         const indexes = comboValue.split(',').map(i => parseInt(i));
         const maxIndex = Math.max(...indexes);
         return $(`[data-supplier-index="${maxIndex}"]`);
     }
     
     // Trova l'ultimo fornitore
     function getLastSupplier() {
         let lastSupplier = null;
         let maxIndex = 0;
         
         $('.supplier-row').each(function() {
             const index = parseInt($(this).attr('data-supplier-index'));
             if (index > maxIndex) {
                 maxIndex = index;
                 lastSupplier = $(this);
             }
         });
         
         return lastSupplier;
     }
     
     // Calcola dettagli somma per ogni fornitore (solo per linee BOE/1100)
     function calculateSumDetails() {
         const suppliers = $('.supplier-row');
         const details = [];
         
         suppliers.each(function() {
             const nome = $(this).find('.nome-fornitore').val();
             const altroNome = $(this).find('.altro-fornitore').val();
             const nomeFornitore = nome === 'ALTRO' ? altroNome : nome;
             const linea = $(this).find('.linea-trasformazione').val();
             
             const quantitaTrasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
             const resaSeconda = parseFloat($(this).find('.resa-seconda').val()) || 0;
             const resaTorchiato = parseFloat($(this).find('.resa-torchiato').val()) || 0;
             
             if (nomeFornitore && quantitaTrasformata > 0) {
                 const qtaSeconda = linea === 'BOE/1100' ? (quantitaTrasformata * resaSeconda / 100).toFixed(1) : '0';
                 const qtaTorchiato = (quantitaTrasformata * resaTorchiato / 100).toFixed(1);
                 
                 details.push({
                     nome: nomeFornitore,
                     linea: linea,
                     seconda: qtaSeconda,
                     torchiato: qtaTorchiato
                 });
             }
         });
         
         return details;
     }
     
     // Formatta dettagli somma
     function formatSumDetails(details, type) {
         if (details.length <= 1) return '';
         
         const parts = details.map(d => `${d.nome} = ${d[type]} kg`);
         return parts.join(' + ');
     }
     
     // Aggiorna somme automatiche per l'ultimo fornitore
     function updateAutoSums() {
         const suppliers = $('.supplier-row');
         if (suppliers.length === 0) return;
         
         const lastSupplier = getLastSupplier();
         
         if (suppliers.length === 1) {
             // Con un solo fornitore, calcola normalmente
             const quantitaTrasformata = parseFloat(lastSupplier.find('.quantita-trasformata').val()) || 0;
             const resaSeconda = parseFloat(lastSupplier.find('.resa-seconda').val()) || 0;
             const resaTorchiato = parseFloat(lastSupplier.find('.resa-torchiato').val()) || 0;
             const linea = lastSupplier.find('.linea-trasformazione').val();
             
             const qtaSeconda = linea === 'BOE/1100' ? (quantitaTrasformata * resaSeconda / 100).toFixed(1) : '0';
             const qtaTorchiato = (quantitaTrasformata * resaTorchiato / 100).toFixed(1);
             
             lastSupplier.find('.quantita-seconda').val(qtaSeconda).removeClass('auto-sum-field');
             lastSupplier.find('.quantita-torchiato').val(qtaTorchiato).removeClass('auto-sum-field');
             lastSupplier.find('.seconda-details').html('');
             lastSupplier.find('.torchiato-details').html('');
             
             // Rimuovi gli stili da tutti
             suppliers.find('.quantita-seconda, .quantita-torchiato').removeClass('auto-sum-field');
         } else {
             // Con più fornitori, calcola le somme
             let totalSeconda = 0;
             let totalTorchiato = 0;
             
             suppliers.each(function() {
                 const quantitaTrasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
                 const resaSeconda = parseFloat($(this).find('.resa-seconda').val()) || 0;
                 const resaTorchiato = parseFloat($(this).find('.resa-torchiato').val()) || 0;
                 const linea = $(this).find('.linea-trasformazione').val();
                 
                 if (quantitaTrasformata > 0) {
                     if (linea === 'BOE/1100') {
                         totalSeconda += (quantitaTrasformata * resaSeconda / 100);
                     }
                     totalTorchiato += (quantitaTrasformata * resaTorchiato / 100);
                 }
             });
             
             // Rimuovi gli stili da tutti i fornitori
             suppliers.find('.quantita-seconda, .quantita-torchiato').removeClass('auto-sum-field');
             suppliers.find('.seconda-details, .torchiato-details').html('');
             
             // Calcola i valori individuali per gli altri fornitori
             suppliers.not(lastSupplier).each(function() {
                 const quantitaTrasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
                 const resaSeconda = parseFloat($(this).find('.resa-seconda').val()) || 0;
                 const resaTorchiato = parseFloat($(this).find('.resa-torchiato').val()) || 0;
                 const linea = $(this).find('.linea-trasformazione').val();
                 
                 const qtaSeconda = linea === 'BOE/1100' ? (quantitaTrasformata * resaSeconda / 100).toFixed(1) : '0';
                 const qtaTorchiato = (quantitaTrasformata * resaTorchiato / 100).toFixed(1);
                 
                 $(this).find('.quantita-seconda').val(qtaSeconda);
                 $(this).find('.quantita-torchiato').val(qtaTorchiato);
             });
             
             // Applica le somme solo all'ultimo fornitore
             lastSupplier.find('.quantita-seconda').val(totalSeconda.toFixed(1)).addClass('auto-sum-field');
             lastSupplier.find('.quantita-torchiato').val(totalTorchiato.toFixed(1)).addClass('auto-sum-field');
             
             // Aggiungi dettagli somma
             const details = calculateSumDetails();
             const secondaDetails = formatSumDetails(details.filter(d => d.linea === 'BOE/1100'), 'seconda');
             const torchiatoDetails = formatSumDetails(details, 'torchiato');
             
             if (secondaDetails) {
                 lastSupplier.find('.seconda-details').html(`<strong>Dettaglio:</strong> ${secondaDetails}`);
             }
             if (torchiatoDetails) {
                 lastSupplier.find('.torchiato-details').html(`<strong>Dettaglio:</strong> ${torchiatoDetails}`);
             }
             
             // Salva i dettagli globalmente
             sumDetailsSeconda = details.filter(d => d.linea === 'BOE/1100');
             sumDetailsTorchiato = details;
         }
     }
     
     // Ottieni nomi fornitori dalla combinazione
     function getSupplierNamesFromCombo(comboValue) {
         const indexes = comboValue.split(',');
         const names = [];
         
         indexes.forEach(index => {
             const supplierRow = $(`[data-supplier-index="${index}"]`);
             const fornitore = supplierRow.find('.nome-fornitore').val() || '';
             const altroFornitore = supplierRow.find('.altro-fornitore').val();
             const nomeFornitore = fornitore === 'ALTRO' ? altroFornitore : fornitore;
             if (nomeFornitore) {
                 names.push(nomeFornitore);
             }
         });
         
         return names.join(' + ');
     }
     
     // Applica combinazione sostituendo quantità succo 1ª nell'ultimo fornitore incluso
     function applyCombination() {
         const selectedCombo = $('#combinazione-fornitori').val();
         if (!selectedCombo) {
             alert('Seleziona prima una combinazione di fornitori');
             return;
         }
         
         const indexes = selectedCombo.split(',');
         let totale = 0;
         combinationDetails = []; // Reset array dettagli combinazioni
         combinationSupplierIndexes = indexes.map(i => parseInt(i)); // Salva gli indici dei fornitori in combinazione
         
         indexes.forEach(index => {
             const supplierRow = $(`[data-supplier-index="${index}"]`);
             
             // Raccogli informazioni complete del fornitore
             const fornitore = supplierRow.find('.nome-fornitore').val() || '';
             const altroFornitore = supplierRow.find('.altro-fornitore').val();
             const nomeFornitore = fornitore === 'ALTRO' ? altroFornitore : fornitore;
             const certificazione = supplierRow.find('.certificazione-prodotto').val() || 'N/D';
             const lineaTrasformazione = supplierRow.find('.linea-trasformazione').val() || 'N/D';
             
             const quantitaTrasformata = parseFloat(supplierRow.find('.quantita-trasformata').val()) || 0;
             const resaPrima = parseFloat(supplierRow.find('.resa-prima').val()) || 0;
             
             if (quantitaTrasformata > 0) {
                 totale += (quantitaTrasformata * resaPrima / 100);
                 
                 // Aggiungi dettagli completi del fornitore
                 combinationDetails.push({
                     nome: nomeFornitore,
                     certificazione: certificazione,
                     linea: lineaTrasformazione,
                     quantita: quantitaTrasformata,
                     resa: resaPrima,
                     risultato: (quantitaTrasformata * resaPrima / 100).toFixed(1),
                     supplierIndex: parseInt(index)
                 });
             }
         });
         
         const lastSupplierInCombo = getLastSupplierInCombination(selectedCombo);
         if (lastSupplierInCombo.length > 0) {
             const quantitaPrimaField = lastSupplierInCombo.find('.quantita-prima');
             quantitaPrimaField.val(totale.toFixed(1));
             quantitaPrimaField.addClass('combination-result');
             // Crea testo dettagliato della combinazione
             const detailedCombination = combinationDetails.map(detail => 
                 `F${detail.supplierIndex} - ${detail.nome} [${detail.certificazione}|${detail.linea}] = ${detail.risultato}kg`
             ).join(' + ');
             
             // Salva anche la versione semplice per compatibilità
             lastCombinationSuppliers = combinationDetails.map(detail => detail.nome).join(' + ');
             
             const noteElement = lastSupplierInCombo.find('.combination-note');
             if (noteElement.length === 0) {
                 quantitaPrimaField.after(`<small class="combination-note text-warning d-block" style="font-size: 11px; line-height: 1.2;">Valore da combinazione fornitori:<br/>${detailedCombination}</small>`);
             } else {
                 noteElement.html(`Valore da combinazione fornitori:<br/>${detailedCombination}`);
             }
             
             alert(`Combinazione applicata! Quantità succo 1ª dell'ultimo fornitore incluso aggiornata a ${totale.toFixed(1)} kg\n\nDettaglio combinazione:\n${combinationDetails.map(d => `F${d.supplierIndex} - ${d.nome} [${d.certificazione}|${d.linea}]: ${d.quantita}kg × ${d.resa}% = ${d.risultato}kg`).join('\n')}`);
             
             // Aggiorna tabella riepilogo
             updateSummaryTable();
         } else {
             alert('Nessun fornitore disponibile per applicare la combinazione');
         }
     }
     
     // Reset combinazione
     function resetCombination() {
         $('.supplier-row').each(function() {
             const quantitaPrimaField = $(this).find('.quantita-prima');
             
             if (quantitaPrimaField.hasClass('combination-result')) {
                 // Rimuovi la classe combination-result
                 quantitaPrimaField.removeClass('combination-result');
                 
                 // Rimuovi la nota di combinazione
                 $(this).find('.combination-note').remove();
                 
                 // Ricalcola il valore basandosi sulla resa
                 calculateYieldQuantities($(this));
             }
         });
         
         // Reset del select combinazioni
         $('#combinazione-fornitori').val('');
         
         // Reset delle variabili memorizzate
         lastCombinationSuppliers = '';
         combinationDetails = [];
         combinationSupplierIndexes = [];
         
         alert('Combinazione rimossa. I valori del succo 1ª sono stati ricalcolati in base alle rese.');
         
         // Aggiorna tabella riepilogo
         updateSummaryTable();
     }
     
     // Aggiorna stili BIO per certificazione, varietà e linea
     function updateBioStyles(supplierElement) {
         const certificazione = supplierElement.find('.certificazione-prodotto').val();
         const certificazioneField = supplierElement.find('.certificazione-prodotto');
         const varietaField = supplierElement.find('.varieta-prodotto');
         const lineaField = supplierElement.find('.linea-trasformazione');
         
         certificazioneField.removeClass('bio-red-field');
         varietaField.removeClass('bio-red-field');
         lineaField.removeClass('bio-red-field');
         
         if (['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(certificazione)) {
             certificazioneField.addClass('bio-red-field');
             varietaField.addClass('bio-red-field');
             lineaField.addClass('bio-red-field');
         }
     }
     
     // Aggiunta nuovo fornitore
     function addSupplier() {
         supplierCount++;
         const template = $('#fornitore-template').html();
         const newSupplier = $(template);
         
         newSupplier.attr('data-supplier-index', supplierCount);
         newSupplier.find('.supplier-number').text(supplierCount);
         
         const agrume = $('#tipo-agrume-giornaliero').val();
         if (agrume) {
             const yields = calculateAutoYields(agrume);
             newSupplier.find('.resa-prima').val(yields.prima);
             newSupplier.find('.resa-seconda').val(yields.seconda);
             newSupplier.find('.resa-torchiato').val(yields.torchiato);
         }
         
         $('#fornitori-container').append(newSupplier);
         
         // Inizializza Select2 per destinazione multipla
         newSupplier.find('.destinazione-prima').select2({
             placeholder: "Seleziona fino a 3 destinazioni",
             maximumSelectionLength: 3,
             language: {
                 maximumSelected: function() {
                     return "Puoi selezionare massimo 3 destinazioni";
                 }
             }
         });
         
         // Nascondi inizialmente la sezione succo 2ª
         newSupplier.find('.seconda-section').addClass('hidden-field');
         
         attachSupplierEvents(newSupplier);
         updateCombinazioneOptions();
         toggleCombinazioniSection();
         updateAutoSums();
     }
     
     // Eventi per ogni fornitore
     function attachSupplierEvents(supplierElement) {
         const index = supplierElement.data('supplier-index');
         
         // Gestione campo "ALTRO" per fornitore
         supplierElement.find('.nome-fornitore').change(function() {
             const altroField = supplierElement.find('.altro-fornitore');
             if ($(this).val() === 'ALTRO') {
                 altroField.removeClass('hidden-field');
             } else {
                 altroField.addClass('hidden-field').val('');
             }
             updateSummaryTable();
             updateCombinazioneOptions();
         });
         
         // Gestione campo "ALTRO" per fornitore (altro fornitore)
         supplierElement.find('.altro-fornitore').on('input', function() {
             updateCombinazioneOptions();
             updateSummaryTable();
         });
         
         // Gestione certificazione e colori
         supplierElement.find('.certificazione-prodotto').change(function() {
             const altroField = supplierElement.find('.altra-certificazione');
             const certificazione = $(this).val();
             
             if (certificazione === 'ALTRO') {
                 altroField.removeClass('hidden-field');
             } else {
                 altroField.addClass('hidden-field').val('');
             }
             
             updateDestinationColors(supplierElement);
             updateBioStyles(supplierElement);
             updateSummaryTable();
             updateCombinazioneOptions();
         });
         
         // Gestione altra certificazione
         supplierElement.find('.altra-certificazione').on('input', function() {
             updateCombinazioneOptions();
             updateSummaryTable();
         });
         
         // Gestione linea di trasformazione
         supplierElement.find('.linea-trasformazione').change(function() {
             updateBioStyles(supplierElement);
             toggleSecondaSection(supplierElement);
             updateCombinazioneOptions();
             updateAutoSums();
             updateSummaryTable();
         });
         
         // Gestione campo "ALTRO" per varietà
         supplierElement.find('.varieta-prodotto').change(function() {
             const altroField = supplierElement.find('.altra-varieta');
             if ($(this).val() === 'ALTRO') {
                 altroField.removeClass('hidden-field');
             } else {
                 altroField.addClass('hidden-field').val('');
             }
             updateSummaryTable();
         });
         
         // Gestione bio status per colori destinazione
         supplierElement.find('.bio-prima').change(function() {
             updateDestinationColors(supplierElement);
             updateSummaryTable();
         });
         
         // Gestione campi "ALTRO" per tenore polpa
         supplierElement.find('.tenore-polpa-prima').change(function() {
             const altroField = supplierElement.find('.altro-tenore-prima');
             if ($(this).val() === 'ALTRO') {
                 altroField.removeClass('hidden-field');
             } else {
                 altroField.addClass('hidden-field').val('');
             }
         });
         
         supplierElement.find('.tenore-polpa-seconda').change(function() {
             const altroField = supplierElement.find('.altro-tenore-seconda');
             if ($(this).val() === 'ALTRO') {
                 altroField.removeClass('hidden-field');
             } else {
                 altroField.addClass('hidden-field').val('');
             }
         });
         
         supplierElement.find('.tenore-polpa-torchiato').change(function() {
             const altroField = supplierElement.find('.altro-tenore-torchiato');
             if ($(this).val() === 'ALTRO') {
                 altroField.removeClass('hidden-field');
             } else {
                 altroField.addClass('hidden-field').val('');
             }
         });
         
         // Gestione campi "ALTRO" per Brix
         supplierElement.find('.brix-prima, .brix-seconda, .brix-torchiato').change(function() {
             const altroField = $(this).hasClass('brix-prima') ? supplierElement.find('.altro-brix-prima') :
                                $(this).hasClass('brix-seconda') ? supplierElement.find('.altro-brix-seconda') :
                                supplierElement.find('.altro-brix-torchiato');
             
             if ($(this).val() === 'ALTRO') {
                 altroField.removeClass('hidden-field');
             } else {
                 altroField.addClass('hidden-field').val('');
             }
         });
         
         // Gestione menu destinazioni multiple per succo 1ª
         supplierElement.find('.destinazione-prima').on('change', function() {
             const selectedValues = $(this).val() || [];
             const container = $(this).parent();
             const bxField = container.find('.bx-concentrato');
             const altroField = container.find('.altra-destinazione');
             
             if (selectedValues.includes('CONCENTRATO')) {
                 bxField.removeClass('hidden-field');
             } else {
                 bxField.addClass('hidden-field').val('');
             }
             
             if (selectedValues.includes('ALTRO')) {
                 altroField.removeClass('hidden-field');
             } else {
                 altroField.addClass('hidden-field').val('');
             }
         });
         
         // Gestione menu concentrato e altro destinazioni per seconda
         supplierElement.find('.destinazione-seconda').change(function() {
             const container = $(this).parent();
             const bxField = container.find('.bx-concentrato');
             const altroField = container.find('.altra-destinazione');
             
             if ($(this).val() === 'CONCENTRATO') {
                 bxField.removeClass('hidden-field');
                 altroField.addClass('hidden-field').val('');
             } else if ($(this).val() === 'ALTRO') {
                 altroField.removeClass('hidden-field');
                 bxField.addClass('hidden-field').val('');
             } else {
                 bxField.addClass('hidden-field').val('');
                 altroField.addClass('hidden-field').val('');
             }
         });
         
         // Gestione menu destinazioni per torchiato
         supplierElement.find('.destinazione-torchiato').change(function() {
             const container = $(this).parent();
             const altroField = container.find('.altra-destinazione');
             
             if ($(this).val() === 'ALTRO') {
                 altroField.removeClass('hidden-field');
             } else {
                 altroField.addClass('hidden-field').val('');
             }
         });
         
         // Calcoli automatici
         supplierElement.find('.quantita-fornitore, .quantita-trasformata, .portata-impianto, .orario-inizio, .resa-prima, .resa-seconda, .resa-torchiato').on('input change', function() {
             calculateEndTime(supplierElement);
             calculateGiacenza(supplierElement);
             calculateYieldQuantities(supplierElement);
             updateTotals();
             updateSummaryTable();
             updateAutoSums();
         });
         
         // Rimozione fornitore
         supplierElement.find('.rimuovi-fornitore').click(function() {
             if (confirm('Sei sicuro di voler rimuovere questo fornitore?')) {
                 supplierElement.remove();
                 updateTotals();
                 updateSummaryTable();
                 updateCombinazioneOptions();
                 toggleCombinazioniSection();
                 renumberSuppliers();
                 updateAutoSums();
             }
         });
     }
     
     // Aggiorna colori destinazione in base a certificazione e bio status
     function updateDestinationColors(supplierElement) {
         const certificazione = supplierElement.find('.certificazione-prodotto').val();
         const bioStatus = supplierElement.find('.bio-prima').val();
         const destinazionePrimaLabel = supplierElement.find('.destinazione-prima-label');
         const destinazionePrimaSelect = supplierElement.find('.destinazione-prima').next('.select2-container');
         
         destinazionePrimaLabel.removeClass('bio-red-text bio-black-text');
         destinazionePrimaSelect.removeClass('bio-red-text bio-black-text');
         
         if (['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(certificazione)) {
             if (bioStatus === 'DECLASSATO') {
                 destinazionePrimaLabel.addClass('bio-black-text');
                 destinazionePrimaSelect.find('.select2-selection').css('color', '#000000').css('font-weight', 'bold');
             } else {
                 destinazionePrimaLabel.addClass('bio-red-text');
                 destinazionePrimaSelect.find('.select2-selection').css('color', '#dc3545').css('font-weight', 'bold');
             }
         }
     }
     
     // Calcolo orario fine lavorazione con gestione giorno successivo
     function calculateEndTime(supplierElement) {
         const quantitaTrasformata = parseFloat(supplierElement.find('.quantita-trasformata').val()) || 0;
         const portata = parseFloat(supplierElement.find('.portata-impianto').val()) || 0;
         const orarioInizio = supplierElement.find('.orario-inizio').val();
         
         if (quantitaTrasformata > 0 && portata > 0 && orarioInizio) {
             const durataTotaleMinuti = Math.round((quantitaTrasformata / portata) * 60);
             const ore = Math.floor(durataTotaleMinuti / 60);
             const minuti = durataTotaleMinuti % 60;
             
             const dataLavorazione = $('#data-lavorazione').val();
             if (!dataLavorazione) {
                 supplierElement.find('.orario-fine-display').html('');
                 supplierElement.find('.durata-lavorazione').val('');
                 return;
             }
             
             // Crea data/ora di inizio
             const [oraInizio, minutiInizio] = orarioInizio.split(':').map(n => parseInt(n));
             const dataInizio = new Date(dataLavorazione);
             dataInizio.setHours(oraInizio, minutiInizio, 0, 0);
             
             // Calcola data/ora di fine
             const dataFine = new Date(dataInizio.getTime() + durataTotaleMinuti * 60 * 1000);
             
             const oreFine = dataFine.getHours().toString().padStart(2, '0');
             const minutiFine = dataFine.getMinutes().toString().padStart(2, '0');
             let orarioFineDisplay = `${oreFine}:${minutiFine}`;
             
             // Controlla se la data è cambiata
             if (dataFine.getDate() !== dataInizio.getDate()) {
                 const giornoSuccessivo = dataFine.getDate();
                 orarioFineDisplay += ` <span class="next-day">(del giorno ${giornoSuccessivo})</span>`;
             }
             
             supplierElement.find('.orario-fine-display').html(orarioFineDisplay);
             supplierElement.find('.durata-lavorazione').val(`${ore}h ${minuti}m`);
         } else {
             supplierElement.find('.orario-fine-display').html('');
             supplierElement.find('.durata-lavorazione').val('');
         }
     }
     
     // Calcolo giacenza per fornitore (Entrata - Trasformata)
     function calculateGiacenza(supplierElement) {
         const quantitaEntrata = parseFloat(supplierElement.find('.quantita-fornitore').val()) || 0;
         const quantitaTrasformata = parseFloat(supplierElement.find('.quantita-trasformata').val()) || 0;
         const giacenza = quantitaEntrata - quantitaTrasformata;
         
         supplierElement.find('.giacenza-fornitore').val(giacenza >= 0 ? giacenza : 0);
     }
     
     // Calcolo quantità prodotti in base alle rese
     function calculateYieldQuantities(supplierElement) {
         const quantitaTrasformata = parseFloat(supplierElement.find('.quantita-trasformata').val()) || 0;
         const resaPrima = parseFloat(supplierElement.find('.resa-prima').val()) || 0;
         
         if (quantitaTrasformata > 0) {
             // Calcola solo la quantità prima se non è un valore da combinazione
             const quantitaPrimaField = supplierElement.find('.quantita-prima');
             if (!quantitaPrimaField.hasClass('combination-result')) {
                 const quantitaPrima = (quantitaTrasformata * resaPrima / 100).toFixed(1);
                 quantitaPrimaField.val(quantitaPrima);
             }
         } else {
             // Reset solo se non è un valore da combinazione
             const quantitaPrimaField = supplierElement.find('.quantita-prima');
             if (!quantitaPrimaField.hasClass('combination-result')) {
                 quantitaPrimaField.val('');
             }
         }
         
         // Le quantità di seconda e torchiato vengono gestite da updateAutoSums()
     }
     
     // Aggiornamento totali
     function updateTotals() {
         let totaleEntrata = 0;
         let totaleTrasformata = 0;
         let totaleGiacenza = 0;
         
         $('.supplier-row').each(function() {
             const entrata = parseFloat($(this).find('.quantita-fornitore').val()) || 0;
             const trasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
             const giacenza = parseFloat($(this).find('.giacenza-fornitore').val()) || 0;
             
             totaleEntrata += entrata;
             totaleTrasformata += trasformata;
             totaleGiacenza += giacenza;
         });
         
         $('#entrata-giornaliera').val(totaleEntrata);
         $('#trasformata-totale').val(totaleTrasformata);
         $('#giacenza-totale').val(totaleGiacenza);
     }
     
     // Rinumerazione fornitori dopo rimozione
     function renumberSuppliers() {
         let newCount = 0;
         $('.supplier-row').each(function() {
             newCount++;
             $(this).attr('data-supplier-index', newCount);
             $(this).find('.supplier-number').text(newCount);
         });
         supplierCount = newCount;
         updateCombinazioneOptions();
     }
     
     // Aggiornamento tabella riepilogo - MODIFICATA per gestire combinazioni e sezione gialla
     function updateSummaryTable() {
         const tableBody = $('#riepilogo-table tbody');
         tableBody.empty();
         
         // Prima aggiungi le righe individuali dei fornitori in combinazione (sezione gialla)
         if (combinationDetails.length > 0) {
             combinationDetails.forEach(detail => {
                 const supplier = $(`[data-supplier-index="${detail.supplierIndex}"]`);
                 if (supplier.length > 0) {
                     const nomeVarieta = supplier.find('.varieta-prodotto').val() === 'ALTRO' ? 
                         supplier.find('.altra-varieta').val() : supplier.find('.varieta-prodotto').val();
                     
                     const isBioSpecific = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(detail.certificazione);
                     const bioStatus = supplier.find('.bio-prima').val() || 'N/D';
                     const isDeclassatoOrNo = bioStatus === 'DECLASSATO' || bioStatus === 'NO';
                     
                     const bioClass = isBioSpecific && !isDeclassatoOrNo ? 'bio-red-text' : 
                                      (isDeclassatoOrNo ? 'bio-black-text' : '');
                     
                     const orarioFineClean = supplier.find('.orario-fine-display').html() ? 
                         supplier.find('.orario-fine-display').html().replace(/<[^>]*>/g, '').replace('del giorno', 'g.') : '';
                     
                     // Gestione destinazioni
                     const destinazioni = supplier.find('.destinazione-prima').val() || [];
                     let destPrima = destinazioni.join(', ') || 'N/D';
                     
                     // Sostituisci "ALTRO" con il valore specifico se presente
                     const altroDestPrima = supplier.find('.destinazione-prima').parent().find('.altra-destinazione').val();
                     if (destPrima.includes('ALTRO') && altroDestPrima) {
                         destPrima = destPrima.replace('ALTRO', altroDestPrima);
                     }
                     
                     const certificationBadge = detail.certificazione.includes('BIO') ? 
                         `<span class="bio-indicator">${detail.certificazione}</span>` : 
                         detail.certificazione;
                     
                     // Colore rosso per "Dest." e "Bio" quando Bio = "SI"
                     const destBioClass = bioStatus === 'SI' ? 'bio-red-text' : bioClass;
                     
                     const row = `
                         <tr class="combination-individual-row">
                             <td><strong>F${detail.supplierIndex} - ${detail.nome}</strong></td>
                             <td><span class="badge bg-primary">${supplier.find('.quantita-fornitore').val() || 0} kg</span></td>
                             <td><span class="badge bg-warning">${supplier.find('.quantita-trasformata').val() || 0} kg</span></td>
                             <td><span class="badge bg-info">${supplier.find('.giacenza-fornitore').val() || 0} kg</span></td>
                             <td class="${bioClass}">${certificationBadge}</td>
                             <td class="${bioClass}">${nomeVarieta || 'N/D'}</td>
                             <td class="${bioClass}"><code>${detail.linea}</code></td>
                             <td>${supplier.find('.portata-impianto').val() || ''}</td>
                             <td><span class="time-display">${supplier.find('.orario-inizio').val() || ''}</span></td>
                             <td><span class="time-display">${orarioFineClean || ''}</span></td>
                             <td>${supplier.find('.durata-lavorazione').val() || ''}</td>
                             <td class="${destBioClass}" style="font-size: 12px;">${destPrima}</td>
                             <td class="${destBioClass}">${bioStatus}</td>
                             <td>
                                 <button class="btn btn-sm btn-outline-primary edit-supplier" data-index="${detail.supplierIndex}">
                                     <i class="bi bi-pencil"></i>
                                 </button>
                                 <button class="btn btn-sm btn-outline-danger delete-supplier" data-index="${detail.supplierIndex}">
                                     <i class="bi bi-trash"></i>
                                 </button>
                             </td>
                         </tr>
                     `;
                     tableBody.append(row);
                 }
             });
         }
         
         // Poi aggiungi le righe normali dei fornitori
         $('.supplier-row').each(function() {
             const supplierIndex = $(this).data('supplier-index');
             const fornitore = $(this).find('.nome-fornitore').val() || '';
             const altroFornitore = $(this).find('.altro-fornitore').val();
             const nomeFornitore = fornitore === 'ALTRO' ? altroFornitore : fornitore;
             
             if (!nomeFornitore) return;
             
             // Controlla se questo fornitore fa parte di una combinazione
             const isInCombination = combinationSupplierIndexes.includes(supplierIndex);
             const hasCombination = $(this).find('.quantita-prima').hasClass('combination-result');
             
             if (isInCombination && !hasCombination) {
                 // Fornitore che fa parte della combinazione ma non è quello che visualizza il risultato - già mostrato sopra
                 return;
             }
             
             let displayRow = {};
             
             if (hasCombination && combinationDetails.length > 0) {
                 // Riga di combinazione
                 const combinedNames = combinationDetails.map(d => `F${d.supplierIndex} - ${d.nome}`).join(' + ');
                 const combinedQuantitaEntrata = combinationDetails.map(d => {
                     const supplier = $(`[data-supplier-index="${d.supplierIndex}"]`);
                     return parseFloat(supplier.find('.quantita-fornitore').val()) || 0;
                 }).join(' + ');
                 const combinedCertificazioni = combinationDetails.map(d => d.certificazione).join(' + ');
                 const combinedVarieta = combinationDetails.map(d => {
                     const supplier = $(`[data-supplier-index="${d.supplierIndex}"]`);
                     const varieta = supplier.find('.varieta-prodotto').val() || '';
                     const altraVarieta = supplier.find('.altra-varieta').val();
                     return varieta === 'ALTRO' ? altraVarieta : varieta;
                 }).join(' + ');
                 const combinedLinee = combinationDetails.map(d => d.linea).join(' + ');
                 
                 displayRow = {
                     fornitore: combinedNames,
                     quantitaEntrata: combinedQuantitaEntrata,
                     quantitaTrasformata: $(this).find('.quantita-trasformata').val() || '0',
                     giacenza: $(this).find('.giacenza-fornitore').val() || '0',
                     certificazione: combinedCertificazioni,
                     varieta: combinedVarieta,
                     linea: combinedLinee,
                     portata: '', // Vuoto per combinazioni come richiesto
                     orarioInizio: '', // Vuoto per combinazioni come richiesto
                     orarioFine: '', // Vuoto per combinazioni come richiesto
                     durata: '',
                     isCombination: true,
                     supplierIndex: supplierIndex
                 };
             } else {
                 // Riga normale
                 const nomeVarieta = $(this).find('.varieta-prodotto').val() === 'ALTRO' ? 
                     $(this).find('.altra-varieta').val() : $(this).find('.varieta-prodotto').val();
                 
                 displayRow = {
                     fornitore: `F${supplierIndex} - ${nomeFornitore}`,
                     quantitaEntrata: $(this).find('.quantita-fornitore').val() || '0',
                     quantitaTrasformata: $(this).find('.quantita-trasformata').val() || '0',
                     giacenza: $(this).find('.giacenza-fornitore').val() || '0',
                     certificazione: $(this).find('.certificazione-prodotto').val() || '',
                     varieta: nomeVarieta || '',
                     linea: $(this).find('.linea-trasformazione').val() || '',
                     portata: $(this).find('.portata-impianto').val() || '',
                     orarioInizio: $(this).find('.orario-inizio').val() || '',
                     orarioFine: $(this).find('.orario-fine-display').html() || '',
                     durata: $(this).find('.durata-lavorazione').val() || '',
                     isCombination: false,
                     supplierIndex: supplierIndex
                 };
             }
             
             // Determina stili per certificazioni biologiche
             const isBioSpecific = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].some(bio => 
                 displayRow.certificazione.includes(bio)
             );
             
             let bioStatus = 'N/D';
             let isDeclassatoOrNo = false;
             
             if (!displayRow.isCombination) {
                 bioStatus = $(this).find('.bio-prima').val() || 'N/D';
                 isDeclassatoOrNo = bioStatus === 'DECLASSATO' || bioStatus === 'NO';
             }
             
             const bioClass = isBioSpecific && !isDeclassatoOrNo ? 'bio-red-text' : 
                              (isDeclassatoOrNo ? 'bio-black-text' : '');
             
             // Gestione destinazioni
             let destPrima = 'N/D';
             if (!displayRow.isCombination) {
                 const destinazioni = $(this).find('.destinazione-prima').val() || [];
                 destPrima = destinazioni.join(', ') || 'N/D';
                 
                 // Sostituisci "ALTRO" con il valore specifico se presente
                 const altroDestPrima = $(this).find('.destinazione-prima').parent().find('.altra-destinazione').val();
                 if (destPrima.includes('ALTRO') && altroDestPrima) {
                     destPrima = destPrima.replace('ALTRO', altroDestPrima);
                 }
             }
             
             const certificationBadge = displayRow.certificazione.includes('BIO') ? 
                 `<span class="bio-indicator">${displayRow.certificazione}</span>` : 
                 displayRow.certificazione;
             
             let rowClass = displayRow.isCombination ? 'combination-row' : '';
             
             // Colore rosso per "Dest." e "Bio" quando Bio = "SI"
             const destBioClass = bioStatus === 'SI' ? 'bio-red-text' : bioClass;
             
             const row = `
                 <tr class="${rowClass}">
                     <td><strong>${displayRow.fornitore}</strong></td>
                     <td><span class="badge bg-primary">${displayRow.quantitaEntrata} kg</span></td>
                     <td><span class="badge bg-warning">${displayRow.quantitaTrasformata} kg</span></td>
                     <td><span class="badge bg-info">${displayRow.giacenza} kg</span></td>
                     <td class="${bioClass}">${certificationBadge}</td>
                     <td class="${bioClass}">${displayRow.varieta}</td>
                     <td class="${bioClass}"><code>${displayRow.linea}</code></td>
                     <td>${displayRow.portata}</td>
                     <td><span class="time-display">${displayRow.orarioInizio}</span></td>
                     <td><span class="time-display">${displayRow.orarioFine}</span></td>
                     <td>${displayRow.durata}</td>
                     <td class="${destBioClass}" style="font-size: 12px;">${destPrima}</td>
                     <td class="${destBioClass}">${bioStatus}</td>
                     <td>
                         <button class="btn btn-sm btn-outline-primary edit-supplier" data-index="${displayRow.supplierIndex}">
                             <i class="bi bi-pencil"></i>
                         </button>
                         <button class="btn btn-sm btn-outline-danger delete-supplier" data-index="${displayRow.supplierIndex}">
                             <i class="bi bi-trash"></i>
                         </button>
                     </td>
                 </tr>
             `;
             tableBody.append(row);
         });
         
         // Eventi per pulsanti nella tabella
         $('.edit-supplier').click(function() {
             const index = $(this).data('index');
             $(`[data-supplier-index="${index}"]`)[0].scrollIntoView({ 
                 behavior: 'smooth', 
                 block: 'center' 
             });
         });
         
         $('.delete-supplier').click(function() {
             const index = $(this).data('index');
             if (confirm('Confermi la rimozione di questo fornitore?')) {
                 $(`[data-supplier-index="${index}"]`).remove();
                 updateTotals();
                 updateSummaryTable();
                 updateCombinazioneOptions();
                 toggleCombinazioniSection();
                 renumberSuppliers();
                 updateAutoSums();
             }
         });
     }
     
     // Gestione statistiche interattive
     function openStatistics() {
         $('#stats-modal').fadeIn();
         if (!chartsInitialized) {
             initializeCharts();
             chartsInitialized = true;
         }
         updateStatistics();
     }
     
     function closeStatistics() {
         $('#stats-modal').fadeOut();
     }
     
     function initializeCharts() {
         // Inizializza i grafici
         const ctxFornitori = document.getElementById('chartFornitori').getContext('2d');
         const ctxRese = document.getElementById('chartRese').getContext('2d');
         
         charts.fornitori = new Chart(ctxFornitori, {
             type: 'pie',
             data: {
                 labels: [],
                 datasets: [{
                     label: 'Quantità trasformata (kg)',
                     data: [],
                     backgroundColor: [
                         '#FF6384',
                         '#36A2EB',
                         '#FFCE56',
                         '#4BC0C0',
                         '#9966FF',
                         '#FF9F40'
                     ]
                 }]
             },
             options: {
                 responsive: true,
                 maintainAspectRatio: false,
                 plugins: {
                     legend: {
                         position: 'bottom'
                     }
                 }
             }
         });
         
         charts.rese = new Chart(ctxRese, {
             type: 'bar',
             data: {
                 labels: ['Succo 1ª', 'Succo 2ª', 'Torchiato'],
                 datasets: [{
                     label: 'Resa Media %',
                     data: [],
                     backgroundColor: ['#28a745', '#ffc107', '#17a2b8']
                 }]
             },
             options: {
                 responsive: true,
                 maintainAspectRatio: false,
                 scales: {
                     y: {
                         beginAtZero: true,
                         max: 50
                     }
                 }
             }
         });
     }
     
     function updateStatistics() {
         const programData = collectProgramData();
         
         const summaryHtml = `
             <div class="summary-item">
                 <div class="summary-value">${programData.fornitori.length}</div>
                 <div class="summary-label">Fornitori Totali</div>
             </div>
             <div class="summary-item">
                 <div class="summary-value">${programData.trasformataTotale.toLocaleString()}</div>
                 <div class="summary-label">Kg Trasformati</div>
             </div>
             <div class="summary-item">
                 <div class="summary-value">${programData.giacenzaTotale.toLocaleString()}</div>
                 <div class="summary-label">Kg Giacenza</div>
             </div>
             <div class="summary-item">
                 <div class="summary-value">${calculateTotalYield(programData).toFixed(1)}%</div>
                 <div class="summary-label">Resa Media Totale</div>
             </div>
         `;
         $('#stats-summary').html(summaryHtml);
         
         updateChartsData(programData);
     }
     
     function calculateTotalYield(data) {
         let totalYield = 0;
         let count = 0;
         
         data.fornitori.forEach(f => {
             if (f.quantitaTrasformata > 0) {
                 const secondaYield = f.linea === 'BOE/1100' ? f.rese.seconda : 0;
                 totalYield += f.rese.prima + secondaYield + f.rese.torchiato;
                 count++;
             }
         });
         
         return count > 0 ? totalYield / count : 0;
     }
     
     function updateChartsData(data) {
         const fornitoriLabels = [];
         const fornitoriData = [];
         
         data.fornitori.forEach(f => {
             const nome = f.nome === 'ALTRO' ? f.altroNome : f.nome;
             if (nome && f.quantitaTrasformata > 0) {
                 fornitoriLabels.push(nome);
                 fornitoriData.push(f.quantitaTrasformata);
             }
         });
         
         charts.fornitori.data.labels = fornitoriLabels;
         charts.fornitori.data.datasets[0].data = fornitoriData;
         charts.fornitori.update();
         
         let resePrima = 0, reseSeconda = 0, reseTorchiato = 0;
         let countRese = 0, countBOE = 0;
         
         data.fornitori.forEach(f => {
             if (f.quantitaTrasformata > 0) {
                 resePrima += f.rese.prima;
                 reseTorchiato += f.rese.torchiato;
                 countRese++;
                 
                 if (f.linea === 'BOE/1100') {
                     reseSeconda += f.rese.seconda;
                     countBOE++;
                 }
             }
         });
         
         if (countRese > 0) {
             charts.rese.data.datasets[0].data = [
                 (resePrima / countRese).toFixed(1),
                 countBOE > 0 ? (reseSeconda / countBOE).toFixed(1) : 0,
                 (reseTorchiato / countRese).toFixed(1)
             ];
         }
         charts.rese.update();
     }
     
     // Raccolta dati programma
     function collectProgramData() {
         const data = {
             tipoAgrume: $('#tipo-agrume-giornaliero').val(),
             dataLavorazione: $('#data-lavorazione').val(),
             entrataGiornaliera: parseFloat($('#entrata-giornaliera').val()) || 0,
             trasformataTotale: parseFloat($('#trasformata-totale').val()) || 0,
             giacenzaTotale: parseFloat($('#giacenza-totale').val()) || 0,
             ultimaRevisione: $('#last-revision').text(),
             lastCombinationSuppliers: lastCombinationSuppliers,
             combinationDetails: combinationDetails,
             combinationSupplierIndexes: combinationSupplierIndexes,
             sumDetailsSeconda: sumDetailsSeconda,
             sumDetailsTorchiato: sumDetailsTorchiato,
             fornitori: []
         };
         
         $('.supplier-row').each(function() {
             const destinazioniPrima = $(this).find('.destinazione-prima').val() || [];
             const linea = $(this).find('.linea-trasformazione').val();
             const supplierIndex = parseInt($(this).data('supplier-index'));
             
             const fornitore = {
                 supplierIndex: supplierIndex,
                 nome: $(this).find('.nome-fornitore').val(),
                 altroNome: $(this).find('.altro-fornitore').val(),
                 quantitaEntrata: parseFloat($(this).find('.quantita-fornitore').val()) || 0,
                 quantitaTrasformata: parseFloat($(this).find('.quantita-trasformata').val()) || 0,
                 giacenza: parseFloat($(this).find('.giacenza-fornitore').val()) || 0,
                 certificazione: $(this).find('.certificazione-prodotto').val(),
                 altraCertificazione: $(this).find('.altra-certificazione').val(),
                 varieta: $(this).find('.varieta-prodotto').val(),
                 altraVarieta: $(this).find('.altra-varieta').val(),
                 lineaTrasformazione: linea,
                 portataImpianto: parseFloat($(this).find('.portata-impianto').val()) || 0,
                 orarioInizio: $(this).find('.orario-inizio').val(),
                 orarioFineDisplay: $(this).find('.orario-fine-display').html(),
                 durataLavorazione: $(this).find('.durata-lavorazione').val(),
                 rese: {
                     prima: parseFloat($(this).find('.resa-prima').val()) || 0,
                     seconda: linea === 'BOE/1100' ? (parseFloat($(this).find('.resa-seconda').val()) || 0) : 0,
                     torchiato: parseFloat($(this).find('.resa-torchiato').val()) || 0
                 },
                 quantitaProdotti: {
                     prima: parseFloat($(this).find('.quantita-prima').val()) || 0,
                     seconda: linea === 'BOE/1100' ? (parseFloat($(this).find('.quantita-seconda').val()) || 0) : 0,
                     torchiato: parseFloat($(this).find('.quantita-torchiato').val()) || 0
                 },
                 hasCombination: $(this).find('.quantita-prima').hasClass('combination-result'),
                 isAutoSum: {
                     seconda: $(this).find('.quantita-seconda').hasClass('auto-sum-field'),
                     torchiato: $(this).find('.quantita-torchiato').hasClass('auto-sum-field')
                 },
                 caratteristicheProdotti: {
                     prima: {
                         tenorePolpa: $(this).find('.tenore-polpa-prima').val(),
                         altroTenore: $(this).find('.altro-tenore-prima').val(),
                         brix: $(this).find('.brix-prima').val(),
                         altroBrix: $(this).find('.altro-brix-prima').val(),
                         bio: $(this).find('.bio-prima').val(),
                         pastorizzato: $(this).find('.pastorizzato-prima').val(),
                         conservato: $(this).find('.conservato-prima').val(),
                         note: $(this).find('.note-prima').val()
                     },
                     seconda: linea === 'BOE/1100' ? {
                         tenorePolpa: $(this).find('.tenore-polpa-seconda').val(),
                         altroTenore: $(this).find('.altro-tenore-seconda').val(),
                         brix: $(this).find('.brix-seconda').val(),
                         altroBrix: $(this).find('.altro-brix-seconda').val(),
                         pastorizzato: $(this).find('.pastorizzato-seconda').val(),
                         conservato: $(this).find('.conservato-seconda').val(),
                         note: $(this).find('.note-seconda').val()
                     } : null,
                     torchiato: {
                         tenorePolpa: $(this).find('.tenore-polpa-torchiato').val(),
                         altroTenore: $(this).find('.altro-tenore-torchiato').val(),
                         brix: $(this).find('.brix-torchiato').val(),
                         altroBrix: $(this).find('.altro-brix-torchiato').val(),
                         pastorizzato: $(this).find('.pastorizzato-torchiato').val(),
                         conservato: $(this).find('.conservato-torchiato').val(),
                         note: $(this).find('.note-torchiato').val()
                     }
                 },
                 destinazioni: {
                     prima: destinazioniPrima.join(', '),
                     primaAltro: $(this).find('.destinazione-prima').parent().find('.altra-destinazione').val() || '',
                     seconda: linea === 'BOE/1100' ? $(this).find('.destinazione-seconda').val() : '',
                     secondaAltro: linea === 'BOE/1100' ? ($(this).find('.destinazione-seconda').parent().find('.altra-destinazione').val() || '') : '',
                     torchiato: $(this).find('.destinazione-torchiato').val(),
                     torchiatoAltro: $(this).find('.destinazione-torchiato').parent().find('.altra-destinazione').val() || ''
                 }
             };
             
             data.fornitori.push(fornitore);
         });
         
         return data;
     }
     
     // Eventi principali
     $('#tipo-agrume-giornaliero').change(function() {
         const agrume = $(this).val();
         if (agrume) {
             const yields = calculateAutoYields(agrume);
             
             $('.supplier-row').each(function() {
                 $(this).find('.resa-prima').val(yields.prima);
                 $(this).find('.resa-seconda').val(yields.seconda);
                 $(this).find('.resa-torchiato').val(yields.torchiato);
                 calculateYieldQuantities($(this));
             });
             
             updateTotals();
             updateAutoSums();
         }
     });
     
     // Pulsante applica combinazione
     $('#applica-combinazione').click(function() {
         applyCombination();
     });
     
     // Pulsante reset combinazione
     $('#reset-combinazione').click(function() {
         resetCombination();
     });
     
     // Pulsante aggiungi fornitore
     $('#aggiungi-fornitore').click(function() {
         if (!$('#tipo-agrume-giornaliero').val()) {
             alert('Seleziona prima il tipo di agrume');
             return;
         }
         addSupplier();
     });
     
     // Pulsante apri statistiche
     $('#apri-statistiche').click(function() {
         openStatistics();
     });
     
     // Chiudi modal statistiche
     $('.close-stats').click(function() {
         closeStatistics();
     });
     
     // Chiudi modal cliccando fuori
     $(window).click(function(event) {
         if (event.target.id === 'stats-modal') {
             closeStatistics();
         }
     });
     
     // Anteprima stampa
     $('#anteprima-stampa').click(function() {
         const programData = collectProgramData();
         generateCompactPrintPreview(programData);
     });
     
     // Generazione anteprima stampa compatta - MODIFICATA per la nuova struttura
     function generateCompactPrintPreview(data) {
         const printWindow = window.open('', '_blank');
         
         // Calcola totali per Succo 2ª e Torchiato
         let totalSeconda = 0;
         let totalTorchiato = 0;
         
         data.fornitori.forEach(f => {
             if (f.quantitaTrasformata > 0) {
                 if (f.lineaTrasformazione === 'BOE/1100') {
                     totalSeconda += (f.quantitaTrasformata * f.rese.seconda / 100);
                 }
                 totalTorchiato += (f.quantitaTrasformata * f.rese.torchiato / 100);
             }
         });
         
         let printContent = `
             <!DOCTYPE html>
             <html>
             <head>
                 <title>Programma Giornaliero - ${data.dataLavorazione}</title>
                 <style>
                     * {
                         margin: 0;
                         padding: 0;
                         box-sizing: border-box;
                     }
                     
                     body { 
                         font-family: 'Arial', sans-serif;
                         font-size: 11px;
                         line-height: 1.3;
                         color: #333;
                         margin: 15px;
                     }
                     
                     .header {
                         text-align: center;
                         margin-bottom: 20px;
                         border-bottom: 2px solid #1e3c72;
                         padding-bottom: 10px;
                     }
                     
                     .header h1 {
                         font-size: 18px;
                         color: #1e3c72;
                         margin-bottom: 5px;
                     }
                     
                     .header-info {
                         display: flex;
                         justify-content: space-around;
                         margin-top: 10px;
                         font-size: 10px;
                     }
                     
                     .suppliers-table {
                         width: 100%;
                         border-collapse: collapse;
                         margin-bottom: 10px;
                         font-size: 8px;
                     }
                     
                     .suppliers-table th {
                         background-color: #1e3c72;
                         color: white;
                         padding: 3px;
                         text-align: center;
                         font-size: 7px;
                     }
                     
                     .suppliers-table td {
                         border: 1px solid #ddd;
                         padding: 2px;
                         text-align: center;
                         vertical-align: middle;
                     }
                     
                     .bio-cell {
                         background-color: #ffebee;
                         color: #dc3545;
                         font-weight: bold;
                     }
                     
                     .bio-black-cell {
                         color: #000000;
                         font-weight: bold;
                     }
                     
                     .combination-group {
                         background-color: #fff3cd;
                         border: 2px solid #ffc107;
                     }
                     
                     .combination-individual {
                         background-color: #fff3cd;
                         border: 1px solid #ffc107;
                     }
                     
                     .combination-header {
                         background-color: #ffc107;
                         color: #856404;
                         font-weight: bold;
                         text-align: center;
                         padding: 3px;
                     }
                     
                     .summary-section {
                         display: grid;
                         grid-template-columns: 1fr 1fr;
                         gap: 15px;
                         margin-bottom: 15px;
                     }
                     
                     .summary-box {
                         border: 1px solid #ddd;
                         padding: 8px;
                         background-color: #f8f9fa;
                     }
                     
                     .summary-title {
                         font-weight: bold;
                         color: #1e3c72;
                         margin-bottom: 6px;
                         font-size: 11px;
                     }
                     
                     .summary-item {
                         display: flex;
                         justify-content: space-between;
                         margin-bottom: 2px;
                         font-size: 9px;
                     }
                     
                     .totals-grid {
                         display: grid;
                         grid-template-columns: repeat(3, 1fr);
                         gap: 8px;
                         margin-bottom: 10px;
                     }
                     
                     .total-item {
                         text-align: center;
                         padding: 6px;
                         background-color: #e7f3ff;
                         border: 1px solid #2a5298;
                     }
                     
                     .total-value {
                         font-size: 14px;
                         font-weight: bold;
                         color: #1e3c72;
                     }
                     
                     .total-label {
                         font-size: 8px;
                         color: #666;
                     }
                     
                     .footer {
                         text-align: center;
                         margin-top: 15px;
                         font-size: 7px;
                         color: #666;
                         border-top: 1px solid #ddd;
                         padding-top: 8px;
                     }
                     
                     @media print {
                         body { margin: 8px; }
                         .header h1 { font-size: 16px; }
                     }
                 </style>
             </head>
             <body>
                 <div class="header">
                     <h1>PROGRAMMA GIORNALIERO TRASFORMAZIONE FRUTTA</h1>
                     <div>Sistema di Gestione Produzione - Simone Gatto</div>
                     <div class="header-info">
                         <div><strong>Data:</strong> ${data.dataLavorazione ? new Date(data.dataLavorazione).toLocaleDateString('it-IT') : 'N/D'}</div>
                         <div><strong>Agrume:</strong> ${data.tipoAgrume || 'N/D'}</div>
                         <div><strong>Fornitori:</strong> ${data.fornitori.length}</div>
                         <div><strong>Generato:</strong> ${new Date().toLocaleDateString('it-IT')} ${new Date().toLocaleTimeString('it-IT')}</div>
                     </div>
                 </div>
                 
                 <div class="totals-grid">
                     <div class="total-item">
                         <div class="total-value">${data.entrataGiornaliera.toLocaleString()}</div>
                         <div class="total-label">Kg Entrata Totale</div>
                     </div>
                     <div class="total-item">
                         <div class="total-value">${data.trasformataTotale.toLocaleString()}</div>
                         <div class="total-label">Kg Trasformati</div>
                     </div>
                     <div class="total-item">
                         <div class="total-value">${data.giacenzaTotale.toLocaleString()}</div>
                         <div class="total-label">Kg Giacenza</div>
                     </div>
                 </div>

                 <table class="suppliers-table">
                     <thead>
                         <tr>
                             <th>Fornitore</th>
                             <th>Q Entrata<br/>(kg)</th>
                             <th>Q Giacenza<br/>(kg)</th>
                             <th>Cert.</th>
                             <th>Varietà</th>
                             <th>Linea</th>
                             <th>Portata<br/>(kg/h)</th>
                             <th>Inizio</th>
                             <th>Fine</th>
                             <th>Succo 1ª<br/>(kg)</th>
                             <th>Pastorizzato</th>
                             <th>Dest.</th>
                             <th>Polpa</th>
                             <th>°BX</th>
                             <th>Cons.</th>
                             <th>Bio</th>
                         </tr>
                     </thead>
                     <tbody>
         `;
         
         // Sezione combinazioni se presenti - con righe individuali
         if (data.combinationDetails && data.combinationDetails.length > 0) {
             printContent += `
                 <tr class="combination-header">
                     <td colspan="16">COMBINAZIONE SUCCO 1ª</td>
                 </tr>
             `;
             
             // Prima aggiungi le righe individuali dei fornitori in combinazione
             data.combinationDetails.forEach((detail) => {
                 const fullSupplierData = data.fornitori.find(f => f.supplierIndex === detail.supplierIndex);
                 
                 if (fullSupplierData) {
                     const nomeVarieta = fullSupplierData.varieta === 'ALTRO' ? fullSupplierData.altraVarieta : fullSupplierData.varieta;
                     const isBioSpecific = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(fullSupplierData.certificazione);
                     const bioStatus = fullSupplierData.caratteristicheProdotti?.prima?.bio || 'N/D';
                     const isDeclassatoOrNo = bioStatus === 'DECLASSATO' || bioStatus === 'NO';
                     
                     const bioClass = isBioSpecific && !isDeclassatoOrNo ? 'bio-cell' : (isDeclassatoOrNo ? 'bio-black-cell' : '');
                     
                     const orarioFineClean = fullSupplierData.orarioFineDisplay ? 
                         fullSupplierData.orarioFineDisplay.replace(/<[^>]*>/g, '').replace('del giorno', 'g.') : '';
                     
                     let destPrima = fullSupplierData.destinazioni.prima ? fullSupplierData.destinazioni.prima : 'N/D';
                     if (destPrima.includes('ALTRO') && fullSupplierData.destinazioni.primaAltro) {
                         destPrima = destPrima.replace('ALTRO', fullSupplierData.destinazioni.primaAltro);
                     }
                     destPrima = destPrima.split(', ').map(d => 
                         d.replace('CONCENTRATO', 'CONC').replace('NAT IN TINI', 'TINI')
                     ).join(',');
                     
                     const polpa = fullSupplierData.caratteristicheProdotti?.prima?.tenorePolpa || 'N/D';
                     const brix = fullSupplierData.caratteristicheProdotti?.prima?.brix || 'N/D';
                     const conservato = fullSupplierData.caratteristicheProdotti?.prima?.conservato || 'N/D';
                     const pastorizzato = fullSupplierData.caratteristicheProdotti?.prima?.pastorizzato || 'N/D';
                     
                     const destBioClass = bioStatus === 'SI' ? 'bio-cell' : bioClass;
                     
                     printContent += `
                         <tr class="combination-individual">
                             <td><strong>F${detail.supplierIndex} - ${detail.nome}</strong></td>
                             <td>${fullSupplierData.quantitaEntrata}</td>
                             <td>${fullSupplierData.giacenza}</td>
                             <td class="${bioClass}">${fullSupplierData.certificazione}</td>
                             <td class="${bioClass}">${nomeVarieta || 'N/D'}</td>
                             <td class="${bioClass}">${fullSupplierData.lineaTrasformazione}</td>
                             <td>${fullSupplierData.portataImpianto}</td>
                             <td>${fullSupplierData.orarioInizio || '-'}</td>
                             <td style="font-size: 7px;">${orarioFineClean || '-'}</td>
                             <td><strong>${detail.risultato}</strong></td>
                             <td>${pastorizzato}</td>
                             <td class="${destBioClass}" style="font-size: 7px;">${destPrima}</td>
                             <td>${polpa}</td>
                             <td>${brix}</td>
                             <td>${conservato}</td>
                             <td class="${destBioClass}">${bioStatus}</td>
                         </tr>
                     `;
                 }
             });
             
             // Poi aggiungi la riga totale combinazione
             const totaleCombinazione = data.combinationDetails.reduce((sum, detail) => sum + parseFloat(detail.risultato), 0);
             const lastCombinationSupplier = data.fornitori.find(f => f.hasCombination);
             
             if (lastCombinationSupplier) {
                 const combinedNames = data.combinationDetails.map(d => `F${d.supplierIndex} - ${d.nome}`).join(' + ');
                 const combinedQuantitaEntrata = data.combinationDetails.map(d => {
                     const supplier = data.fornitori.find(f => f.supplierIndex === d.supplierIndex);
                     return supplier ? supplier.quantitaEntrata : 0;
                 }).join(' + ');
                 const combinedCertificazioni = data.combinationDetails.map(d => d.certificazione).join(' + ');
                 const combinedVarieta = data.combinationDetails.map(d => {
                     const supplier = data.fornitori.find(f => f.supplierIndex === d.supplierIndex);
                     if (supplier) {
                         const varieta = supplier.varieta === 'ALTRO' ? supplier.altraVarieta : supplier.varieta;
                         return varieta || 'N/D';
                     }
                     return 'N/D';
                 }).join(' + ');
                 const combinedLinee = data.combinationDetails.map(d => d.linea).join(' + ');
               const pastorizzatoTotale = lastCombinationSupplier.caratteristicheProdotti?.prima?.pastorizzato || 'N/D';
                 const polpaTotale = lastCombinationSupplier.caratteristicheProdotti?.prima?.tenorePolpa || 'N/D';
                 const brixTotale = lastCombinationSupplier.caratteristicheProdotti?.prima?.brix || 'N/D';
                 const conservatoTotale = lastCombinationSupplier.caratteristicheProdotti?.prima?.conservato || 'N/D';
                 const bioTotale = lastCombinationSupplier.caratteristicheProdotti?.prima?.bio || 'N/D';
                 
                 let destTotale = lastCombinationSupplier.destinazioni.prima || 'N/D';
                 if (destTotale.includes('ALTRO') && lastCombinationSupplier.destinazioni.primaAltro) {
                     destTotale = destTotale.replace('ALTRO', lastCombinationSupplier.destinazioni.primaAltro);
                 }
                 destTotale = destTotale.split(', ').map(d => 
                     d.replace('CONCENTRATO', 'CONC').replace('NAT IN TINI', 'TINI')
                 ).join(',');
                 
                 const destBioClass = bioTotale === 'SI' ? 'bio-cell' : '';
                 
                 printContent += `
                     <tr class="combination-group">
                         <td><strong>${combinedNames}</strong></td>
                         <td>${combinedQuantitaEntrata}</td>
                         <td>${lastCombinationSupplier.giacenza}</td>
                         <td>${combinedCertificazioni}</td>
                         <td>${combinedVarieta}</td>
                         <td>${combinedLinee}</td>
                         <td></td>
                         <td></td>
                         <td></td>
                         <td><strong>${totaleCombinazione.toFixed(1)} (C)</strong></td>
                         <td>${pastorizzatoTotale}</td>
                         <td class="${destBioClass}" style="font-size: 7px;">${destTotale}</td>
                         <td>${polpaTotale}</td>
                         <td>${brixTotale}</td>
                         <td>${conservatoTotale}</td>
                         <td class="${destBioClass}">${bioTotale}</td>
                     </tr>
                 `;
             }
         }
         
         // Genera righe fornitori normali - evitando ripetizioni
         data.fornitori.forEach((fornitore) => {
             if (!fornitore.nome) return;
             
             const isInCombination = data.combinationSupplierIndexes && 
                 data.combinationSupplierIndexes.includes(fornitore.supplierIndex);
             
             // Se non fa parte di una combinazione, o se fa parte di una combinazione ma è l'ultimo (quello con il risultato)
             if (!isInCombination || fornitore.hasCombination) {
                 // Se ha combinazione, salta perché è già stato mostrato sopra
                 if (fornitore.hasCombination) {
                     return;
                 }
                 
                 const nomeFornitore = fornitore.nome === 'ALTRO' ? fornitore.altroNome : fornitore.nome;
                 const nomeVarieta = fornitore.varieta === 'ALTRO' ? fornitore.altraVarieta : fornitore.varieta;
                 const isBioSpecific = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(fornitore.certificazione);
                 const bioStatus = fornitore.caratteristicheProdotti?.prima?.bio || 'N/D';
                 const isDeclassatoOrNo = bioStatus === 'DECLASSATO' || bioStatus === 'NO';
                 
                 const bioClass = isBioSpecific && !isDeclassatoOrNo ? 'bio-cell' : (isDeclassatoOrNo ? 'bio-black-cell' : '');
                 
                 const orarioFineClean = fornitore.orarioFineDisplay ? 
                     fornitore.orarioFineDisplay.replace(/<[^>]*>/g, '').replace('del giorno', 'g.') : '';
                 
                 let destPrima = fornitore.destinazioni.prima ? fornitore.destinazioni.prima : 'N/D';
                 if (destPrima.includes('ALTRO') && fornitore.destinazioni.primaAltro) {
                     destPrima = destPrima.replace('ALTRO', fornitore.destinazioni.primaAltro);
                 }
                 destPrima = destPrima.split(', ').map(d => 
                     d.replace('CONCENTRATO', 'CONC').replace('NAT IN TINI', 'TINI')
                 ).join(',');
                 
                 const polpa = fornitore.caratteristicheProdotti?.prima?.tenorePolpa || 'N/D';
                 const brix = fornitore.caratteristicheProdotti?.prima?.brix || 'N/D';
                 const conservato = fornitore.caratteristicheProdotti?.prima?.conservato || 'N/D';
                 const pastorizzato = fornitore.caratteristicheProdotti?.prima?.pastorizzato || 'N/D';
                 
                 const destBioClass = bioStatus === 'SI' ? 'bio-cell' : bioClass;
                 
                 printContent += `
                     <tr>
                         <td><strong>F${fornitore.supplierIndex} - ${nomeFornitore || 'N/D'}</strong></td>
                         <td>${fornitore.quantitaEntrata}</td>
                         <td>${fornitore.giacenza}</td>
                         <td class="${bioClass}">${fornitore.certificazione || 'N/D'}</td>
                         <td class="${bioClass}">${nomeVarieta || 'N/D'}</td>
                         <td class="${bioClass}">${fornitore.lineaTrasformazione || 'N/D'}</td>
                         <td>${fornitore.portataImpianto}</td>
                         <td>${fornitore.orarioInizio || '-'}</td>
                         <td style="font-size: 7px;">${orarioFineClean || '-'}</td>
                         <td><strong>${fornitore.quantitaProdotti.prima}</strong></td>
                         <td>${pastorizzato}</td>
                         <td class="${destBioClass}" style="font-size: 7px;">${destPrima}</td>
                         <td>${polpa}</td>
                         <td>${brix}</td>
                         <td>${conservato}</td>
                         <td class="${destBioClass}">${bioStatus}</td>
                     </tr>
                 `;
             }
         });
         
         printContent += `
                     </tbody>
                 </table>
         `;
         
         // Legenda
         printContent += `
             <div style="font-size: 7px; margin-bottom: 10px;">
                 <strong>Legenda:</strong> (C) = Valore da Combinazione | Cert. = Certificazione | Dest. = Destinazione | Cons. = Conservato | Bio = Biologico
             </div>
         `;
         
         // Trova ultimo fornitore valido per sezioni riepilogo
         const lastValidSupplierBOE = data.fornitori.filter(f => f.nome && f.lineaTrasformazione === 'BOE/1100').slice(-1)[0];
         const lastValidSupplier = data.fornitori.filter(f => f.nome).slice(-1)[0];
         
         // Sezione riepilogo
         if (totalSeconda > 0 && lastValidSupplierBOE) {
             let destSeconda = lastValidSupplierBOE.destinazioni.seconda || 'N/D';
             if (destSeconda === 'ALTRO' && lastValidSupplierBOE.destinazioni.secondaAltro) {
                 destSeconda = lastValidSupplierBOE.destinazioni.secondaAltro;
             }
             
             let destTorchiato = 'N/D';
             if (lastValidSupplier) {
                 destTorchiato = lastValidSupplier.destinazioni.torchiato || 'N/D';
                 if (destTorchiato === 'ALTRO' && lastValidSupplier.destinazioni.torchiatoAltro) {
                     destTorchiato = lastValidSupplier.destinazioni.torchiatoAltro;
                 }
             }
             
             printContent += `
                     <div class="summary-section">
                         <div class="summary-box">
                             <div class="summary-title">TOTALI SUCCO 2ª</div>
                             <div class="summary-item">
                                 <span>Quantità Totale:</span>
                                 <span><strong>${totalSeconda.toFixed(1)} kg</strong></span>
                             </div>
                             <div class="summary-item">
                                 <span>Destinazione:</span>
                                 <span>${destSeconda}</span>
                             </div>
                             <div class="summary-item">
                                 <span>Polpa:</span>
                                 <span>${lastValidSupplierBOE.caratteristicheProdotti?.seconda?.tenorePolpa || 'N/D'}</span>
                             </div>
                             <div class="summary-item">
                                 <span>°BX:</span>
                                 <span>${lastValidSupplierBOE.caratteristicheProdotti?.seconda?.brix || 'N/D'}</span>
                             </div>
                             <div class="summary-item">
                                 <span>Conservato:</span>
                                 <span>${lastValidSupplierBOE.caratteristicheProdotti?.seconda?.conservato || 'N/D'}</span>
                             </div>
                             ${data.sumDetailsSeconda && data.sumDetailsSeconda.length > 1 ? `
                                 <div style="margin-top: 4px; font-size: 7px; color: #666;">
                                     <strong>Dettaglio:</strong> ${formatSumDetails(data.sumDetailsSeconda, 'seconda')}
                                 </div>
                             ` : ''}
                         </div>
                         
                         <div class="summary-box">
                             <div class="summary-title">TOTALI TORCHIATO</div>
                             <div class="summary-item">
                                 <span>Quantità Totale:</span>
                                 <span><strong>${totalTorchiato.toFixed(1)} kg</strong></span>
                             </div>
                             <div class="summary-item">
                                 <span>Destinazione:</span>
                                 <span>${destTorchiato}</span>
                             </div>
                             ${lastValidSupplier ? `
                                 <div class="summary-item">
                                     <span>Polpa:</span>
                                     <span>${lastValidSupplier.caratteristicheProdotti?.torchiato?.tenorePolpa || 'N/D'}</span>
                                 </div>
                                 <div class="summary-item">
                                     <span>°BX:</span>
                                     <span>${lastValidSupplier.caratteristicheProdotti?.torchiato?.brix || 'N/D'}</span>
                                 </div>
                                 <div class="summary-item">
                                     <span>Conservato:</span>
                                     <span>${lastValidSupplier.caratteristicheProdotti?.torchiato?.conservato || 'N/D'}</span>
                                 </div>
                             ` : ''}
                             ${data.sumDetailsTorchiato && data.sumDetailsTorchiato.length > 1 ? `
                                 <div style="margin-top: 4px; font-size: 7px; color: #666;">
                                     <strong>Dettaglio:</strong> ${formatSumDetails(data.sumDetailsTorchiato, 'torchiato')}
                                 </div>
                             ` : ''}
                         </div>
                     </div>
             `;
         } else {
             let destTorchiato = 'N/D';
             if (lastValidSupplier) {
                 destTorchiato = lastValidSupplier.destinazioni.torchiato || 'N/D';
                 if (destTorchiato === 'ALTRO' && lastValidSupplier.destinazioni.torchiatoAltro) {
                     destTorchiato = lastValidSupplier.destinazioni.torchiatoAltro;
                 }
             }
             
             printContent += `
                     <div class="summary-section">
                         <div class="summary-box" style="grid-column: 1 / -1;">
                             <div class="summary-title">TOTALI TORCHIATO</div>
                             <div class="summary-item">
                                 <span>Quantità Totale:</span>
                                 <span><strong>${totalTorchiato.toFixed(1)} kg</strong></span>
                             </div>
                             <div class="summary-item">
                                 <span>Destinazione:</span>
                                 <span>${destTorchiato}</span>
                             </div>
                             ${lastValidSupplier ? `
                                 <div class="summary-item">
                                     <span>Polpa:</span>
                                     <span>${lastValidSupplier.caratteristicheProdotti?.torchiato?.tenorePolpa || 'N/D'}</span>
                                 </div>
                                 <div class="summary-item">
                                     <span>°BX:</span>
                                     <span>${lastValidSupplier.caratteristicheProdotti?.torchiato?.brix || 'N/D'}</span>
                                 </div>
                                 <div class="summary-item">
                                     <span>Conservato:</span>
                                     <span>${lastValidSupplier.caratteristicheProdotti?.torchiato?.conservato || 'N/D'}</span>
                                 </div>
                             ` : ''}
                             ${data.sumDetailsTorchiato && data.sumDetailsTorchiato.length > 1 ? `
                                 <div style="margin-top: 4px; font-size: 7px; color: #666;">
                                     <strong>Dettaglio:</strong> ${formatSumDetails(data.sumDetailsTorchiato, 'torchiato')}
                                 </div>
                             ` : ''}
                         </div>
                     </div>
             `;
         }
         
         printContent += `
                     <div class="footer">
                         <p>Documento generato automaticamente - Sistema di Gestione Produzione Simone Gatto</p>
                         <p>Ultima revisione: ${data.ultimaRevisione}</p>
                     </div>
                 </body>
                 </html>
         `;
         
         printWindow.document.write(printContent);
         printWindow.document.close();
         printWindow.focus();
     }
     
     // Salvataggio programma
     $('#salva-programma').click(function() {
         if (!validateProgram()) {
             return;
         }
         
         const programData = collectProgramData();
         
         console.log('Dati programma:', programData);
         
         const programId = 'PROG-' + new Date().getTime().toString().substr(-6);
         alert(`Programma salvato con successo!\nID Programma: ${programId}\nData: ${programData.dataLavorazione}\nTipo Agrume: ${programData.tipoAgrume}\nFornitori: ${programData.fornitori.length}`);
         
         updateLastRevision();
     });
     
     // Validazione programma
     function validateProgram() {
         if (!$('#tipo-agrume-giornaliero').val()) {
             alert('Seleziona il tipo di agrume');
             return false;
         }
         
         if (!$('#data-lavorazione').val()) {
             alert('Inserisci la data di lavorazione');
             return false;
         }
         
         if ($('.supplier-row').length === 0) {
             alert('Aggiungi almeno un fornitore');
             return false;
         }
         
         let isValid = true;
         $('.supplier-row').each(function() {
             const fornitore = $(this).find('.nome-fornitore').val();
             
             if (!fornitore) {
                 isValid = false;
                 $(this)[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                 alert('Inserisci almeno il nome del fornitore');
                 return false;
             }
         });
         
         return isValid;
     }
     
     // Reset programma
     $('#reset-programma').click(function() {
         if (confirm('Attenzione: questa operazione cancellerà tutti i dati inseriti. Continuare?')) {
             location.reload();
         }
     });
     
     // Inizializzazione
     initCurrentDate();
     
     console.log('Sistema Programma Giornaliero Trasformazione inizializzato con successo');
 });
</script>
</body>
</html>
